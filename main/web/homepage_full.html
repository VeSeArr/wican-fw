<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>WiCAN</title>
    <style>
        :root {
            --primary-color: #24478f;
            --primary-light: #c2d1f0;
            --primary-dark: #1a3266;
            --background-color: #f0f2f5;
            --white: #ffffff;
            --gray-100: #f7f7f7;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            background-color: var(--background-color);
            margin: 0;
            overflow-x: hidden;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .sidebar {
            height: 100vh;
            width: 240px;
            background-color: var(--white);
            border-right: 1px solid var(--gray-200);
            padding-top: 1rem;
            position: fixed;
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
        }

        .sidebar button {
            background-color: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 1rem 1.5rem;
            text-align: left;
            width: 100%;
            transition: var(--transition);
            font-size: 0.95rem;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar button:hover {
            background-color: var(--gray-100);
            color: var(--primary-color);
        }

        .sidebar button.active {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
        }

        .logo {
            width: 80%;
            max-width: 100%;
            max-height: 100%;
            height: auto;
            display: block;
            margin: 2.5rem auto 0;
            padding: 0;
            margin-bottom: 0; /* or reduce the value */
            padding-bottom: 0; /* or reduce the value */
        }

        .content {
            margin-left: 240px;
            padding: 2rem;
            width: calc(100% - 240px);
            max-width: 1200px;
        }

        .tabcontent {
            display: none;
            padding: 1.5rem;
            border-radius: 8px;
            background-color: var(--white);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
        }

        .description-text {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .form-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
            font-weight: 600;
        }

        .form-table td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        .form-table td:first-child {
            width: 40%;
            font-weight: 500;
            color: var(--gray-700);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 100%;
        }

        input[type="text"],
        input[type="file"],
        input[type="number"] {
            width: calc(100% - 1.3rem - 2px);
        }

        input,
        select {
            width: 100%;
            padding: 0.65rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: var(--white);
        }

        input:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(36, 71, 143, 0.1);
            outline: none;
        }

        input:disabled,
        input[type="number"]:disabled,
        select:disabled {
            background-color: var(--gray-100);
            cursor: not-allowed;
        }

        button,
        input[type="button"],
        .store {
            padding: 0.65rem 1.25rem;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            width: auto;
        }

        button:hover,
        input[type="button"]:hover,
        .store:hover {
            background-color: var(--primary-dark);
        }

        button:disabled,
        input[type="button"]:disabled,
        .store:disabled {
            background-color: var(--gray-400);
            cursor: not-allowed;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 1rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .divider {
            margin: 1.5rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        #table2 {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1rem 0;
        }

        #table2 th,
        #table2 td {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
        }

        #table2 th {
            background-color: var(--gray-100);
            font-weight: 600;
            text-align: left;
        }

        #table2 tr:nth-child(even) {
            background-color: var(--gray-50);
        }


        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-connected {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-disconnected {
            background-color: #fee2e2;
            color: #991b1b;
        }

        input[type="file"] {
            padding: 0.5rem;
            border: 1px dashed var(--gray-400);
            border-radius: 6px;
            background-color: var(--gray-50);
            cursor: pointer;
        }

        input[type="file"]:hover {
            border-color: var(--primary-color);
        }

        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .notification-container {
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            z-index: 1000;
            padding: 1rem;
            font-weight: 500;
            display: none;
            transition: all 0.3s ease;
        }

        .notification-container.show {
            display: block;
        }
        .form-input::placeholder {
            font-size: 14px; /* Adjust the size as needed */
            color: #888; /* Optional: Customize the color */
        }
/*********************************/
/* Add only these new styles */
.custom-init-group {
    margin-bottom: 1.5rem;
}

.custom-init-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--gray-700);
}

.pid-entry {
    border: none;
    border-radius: 8px;
    padding: 0rem;
    margin-bottom: 0.2rem;
    background: var(--white);
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--gray-600);
}

.pid-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.pid-title {
    color: var(--gray-700);
}

.pid-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.pid-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.pid-field label {
    color: var(--gray-700);
}

.pid-field input,
.pid-field select {
    width: 50%;
    padding: 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
}

.button-group {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
}
/*********************************/

        @media (max-width: 768px) {
            .notification-container {
                left: 0;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
        }
        .system-button {
            min-width: 110px;
            width: auto;
            padding: 0.65rem 1.25rem;
            white-space: nowrap;
            margin: 0.1rem;
        }

        @media (max-width: 768px) {
            .system-button {
                min-width: 110px;
                width: 100%;
                margin: 0.1rem 0;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }
            
            .form-table td {
                display: block;
                width: 100%;
            }
            
            .form-table td:first-child {
                padding-bottom: 0.25rem;
            }
            .compact-form-table {
                width: 100%;
                border-collapse: collapse;
            }

            .compact-form-table td {
                padding: 3px;
                vertical-align: middle;
                font-size: 0.85rem;
            }

            .compact-form-table input,
            .compact-form-table select {
                width: 95%;
                padding: 2px 5px;
                height: 24px;
                font-size: 0.85rem;
                border: 1px solid var(--gray-300);
                border-radius: 4px;
            }
        }


        #wifi_networks_list option {
            padding: 0.25rem;
        }

        .wifi-scan-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .wifi-scan-container input {
            flex: 1;
        }

        #wifi_scan_button {
            min-width: 60px;
            white-space: nowrap;
        }

    </style>
</head>

<body onload="Load();">
    <div class="sidebar">
        <embed src="/logo.svg" class="logo" />
        <button class="tablinks" onclick="openTab(event, 'status_view')" id="defaultOpen">
            <span data-lucide="signal" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Status</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'wifi_settings')">
            <span data-lucide="settings" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Settings</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'automate')">
            <span data-lucide="zap" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Automate</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'dashboard_tab')">
            <span data-lucide="bar-chart-3" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Dashboard</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'power_saving_tab')">
            <span data-lucide="battery" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Power Saving</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'logger')">
            <span data-lucide="file-text" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Logger Settings</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'monitor')">
            <span data-lucide="monitor" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>CAN Monitor</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'advanced_tab')">
            <span data-lucide="settings" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>Advanced</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'system_tab')">
            <span data-lucide="cpu" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>System</b>
        </button>
        <button class="tablinks" onclick="openTab(event, 'about_tab')">
            <span data-lucide="info" style="width: 18px; height: 18px; margin-right: 8px;"></span>
            <b>About</b>
        </button>
    </div>

    <div class="content">
        <div id="notification" class="notification-container"></div>
        <div id="dashboard_tab" class="tabcontent">
            <div class="section-title">Dashboard</div>
            <div id="dashboard-content">
                <p>Loading dashboard content...</p>
            </div>
        </div>
        <div id="sleep_warning_div" style="display: none;">
            <div class="divider"></div>
            <div class="section-title" style="color: #dc2626;">⚠️ Sleep Mode Disabled Warning</div>
            <table class="form-table">
                <tr>
                    <td colspan="2" style="background-color: #fee2e2; padding: 1rem; border-radius: 6px;">
                        <strong>WARNING:</strong> Disabling sleep mode will continuously drain your vehicle's battery and may cause battery discharge when the vehicle is off. This should only be disabled for testing purposes.
                    </td>
                </tr>
                <tr>
                    <td><label for="sleep_disable_agree"><b>I understand the risks:</b></label></td>
                    <td>
                        <select name="sleep_disable_agree" id="sleep_disable_agree" onChange="submit_enable();">
                            <option value="no">No - I do not agree</option>
                            <option value="yes">Yes - I understand and agree</option>
                        </select>
                    </td>
                </tr>
            </table>
        </div>
        <div id="status_view" class="tabcontent">
            <div class="section-title">Status</div>
            <table class="form-table">
                <tr>
                    <td>WiFi Mode:</td>
                    <td>
                        <div id="wifi_mode_current">AP&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>AP Channel:</td>
                    <td>
                        <div id="ap_channel_status">6&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>WiFi Station:</td>
                    <td>
                        <div id="sta_status">Not Connected&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Station IP:</td>
                    <td>
                        <div id="sta_ip">192.168.3.1&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>mDNS:</td>
                    <td>
                        <div id="mdns">&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>CAN Bitrate:</td>
                    <td>
                        <div id="can_bitrate_status">500K&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>CAN Mode:</td>
                    <td>
                        <div id="can_mode_status">Silent&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Port Type:</td>
                    <td>
                        <div id="port_type_status">TCP&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>TCP/UDP Port:</td>
                    <td>
                        <div id="port_status">3333&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td>Battery Voltage:</td>
                    <td>
                        <div id="batt_voltage">12.8V&nbsp;</div>
                    </td>
                </tr>
                <tr>
                    <td><input id="check_status_button" name="check_status_button" type="button" onclick="checkStatus()"
                            value="Check status" /></td>
                    <td>&nbsp;</td>
                </tr>
            </table>
        </div>

        <div id="wifi_settings" class="tabcontent">
            <form id="configForm" name="configForm" action="/action_page" onchange="submit_enable();">
                <div class="section-title">AP Config</div>
                <table class="form-table">
                    <tr>
                        <td>Mode:</td>
                        <td>
                            <select name="wifi_mode" id="wifi_mode" onchange="toggleSmartConnectConfig(); submit_enable();">
                                <option value="AP">AP</option>
                                <option value="APStation">AP+Station</option>
                                <option value="SmartConnect">SmartConnect</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>AP Channel:</td>
                        <td>
                            <select name="ap_ch_value" id="ap_ch_value">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>AP Password:</td>
                        <td>
                            <input type="text" id="ap_pass_value" name="ap_pass_value" value="Testpass" />
                        </td>
                    </tr>
                    <tr>
                        <td>Auto-Disable AP:</td>
                        <td>
                            <select name="ap_auto_disable" id="ap_auto_disable" onchange="submit_enable();">
                                <option value="enable">Enable</option>
                                <option value="disable">Disable</option>
                            </select>
                        </td>
                    </tr>
                </table>

                <!-- SmartConnect Configuration -->
                <div id="smartconnect_config" style="display: none;">
                    <div class="divider"></div>
                    <div class="section-title">SmartConnect Configuration</div>
                    
                    <!-- Home Mode Configuration -->
                    <div class="divider"></div>
                    <div class="section-title" style="font-size: 1.25rem; color: #2563eb; border-bottom: 2px solid #93c5fd; padding-bottom: 0.25rem; display: flex; align-items: center; gap: 8px;">
                        <span data-lucide="home" style="width: 20px; height: 20px;"></span>
                        Home Mode
                    </div>
                    <table class="form-table">
                        <tr>
                            <td>Home SSID:</td>
                            <td>
                                <input type="text" id="home_ssid" name="home_ssid" value="MeatPi" oninput="submit_enable();" />
                            </td>
                        </tr>
                        <tr>
                            <td>Home Password:</td>
                            <td>
                                <input type="text" id="home_password" name="home_password" value="TomatoSauce" oninput="submit_enable();" />
                            </td>
                        </tr>
                        <tr>
                            <td>Home Security:</td>
                            <td>
                                <select id="home_security" name="home_security" onchange="submit_enable();">
                                    <option value="wpa3">WPA3</option>
                                    <option value="wpa2">WPA2</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Home Protocol:</td>
                            <td>
                                <select id="home_protocol" name="home_protocol" onchange="submit_enable();">
                                    <option value="elm327">elm327</option>
                                    <option value="auto_pid">AutoPID</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Drive Mode Configuration -->
                    <div class="divider"></div>
                    <div class="section-title" style="font-size: 1.25rem; color: #059669; border-bottom: 2px solid #6ee7b7; padding-bottom: 0.25rem; display: flex; align-items: center; gap: 8px;">
                        <span data-lucide="car" style="width: 20px; height: 20px;"></span>
                        Drive Mode
                    </div>
                    <table class="form-table">
                        <tr>
                            <td>Drive Connection Type:</td>
                            <td>
                                <select name="drive_connection_type" id="drive_connection_type" onchange="toggleDriveConfig(); submit_enable();">
                                    <option value="wifi">WiFi</option>
                                    <option value="ble">BLE</option>
                                </select>
                            </td>
                        </tr>
                        <tr id="drive_wifi_config">
                            <td>Drive SSID:</td>
                            <td>
                                <input type="text" id="drive_ssid" name="drive_ssid" value="MeatPi" oninput="submit_enable();" />
                            </td>
                        </tr>
                        <tr id="drive_wifi_password">
                            <td>Drive Password:</td>
                            <td>
                                <input type="text" id="drive_password" name="drive_password" value="TomatoSauce" oninput="submit_enable();" />
                            </td>
                        </tr>
                        <tr id="drive_wifi_security">
                            <td>Drive Security:</td>
                            <td>
                                <select id="drive_security" name="drive_security" onchange="submit_enable();">
                                    <option value="wpa3">WPA3</option>
                                    <option value="wpa2">WPA2</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Drive Protocol:</td>
                            <td>
                                <select id="drive_protocol" name="drive_protocol" onchange="submit_enable();">
                                    <option value="elm327">elm327</option>
                                    <option value="auto_pid">AutoPID</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Drive Mode Timeout:</td>
                            <td class="slider-container">
                                <input type="range" 
                                       id="drive_mode_timeout" 
                                       name="drive_mode_timeout" 
                                       value="60" 
                                       min="10" 
                                       max="600" 
                                       step="1"
                                       oninput="document.getElementById('drive_mode_timeout_value').textContent = this.value;submit_enable();">
                                <span id="drive_mode_timeout_value">60</span>sec
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="divider"></div>

                <!-- Network Configuration Section -->
                <div id="station_config_section">
                    <div class="section-title">Network Configuration</div>
                    <table class="form-table">
                        <tr>
                            <td>SSID:</td>
                            <td>
                                <div class="wifi-scan-container">
                                    <input type="text" id="ssid_value" name="ssid_value" value="MeatPi" disabled />
                                    <button type="button" id="wifi_scan_button" onclick="scanWifiNetworks()" disabled>Scan</button>
                                </div>
                            </td>
                        </tr>
                        <tr id="wifi_networks_row" style="display: none;">
                            <td>Available Networks:</td>
                            <td>
                                <select id="wifi_networks_list" onchange="selectWifiNetwork()">
                                    <option value="">Select a network...</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Password:</td>
                            <td>
                                <input type="text" id="pass_value" name="pass_value" value="TomatoSauce" disabled />
                            </td>
                        </tr>
                        <tr>
                            <td>Security:</td>
                            <td>
                                <select id="sta_security" name="sta_security" disabled>
                                    <option value="wpa3">WPA3</option>
                                    <option value="wpa2">WPA2</option>
                                </select>
                            </td>
                        </tr>
                    </table>

                    <div class="divider"></div>
                    <div class="section-title">Backup Networks <span style="font-weight: normal; font-size: 0.9rem; color: #6b7280;">(max 5)</span></div>
                    <div id="fallback_networks_container">
                        <div id="fallback_rows"></div>
                        <div class="button-group">
                            <button type="button" id="add_fallback_button" onclick="addFallbackNetworkRow()">Add SSID</button>
                        </div>
                        <div style="color:#6b7280; font-size: 12px; margin-top: 6px;">These SSIDs are used as backup networks if the primary station fails.</div>
                    </div>
                </div>
                
                <div class="divider"></div>

                <div class="section-title">BLE</div>
                <table class="form-table">
                    <tr>
                        <td>Passkey:</td>
                        <td>
                            <input type="number" id="ble_pass_value" name="ble_pass_value" value="000000" min="0" max="999999" />
                        </td>
                    </tr>
                    <tr>
                        <td>BLE Status:</td>
                        <td>
                            <select name="ble_status" id="ble_status" onchange="submit_enable();">
                                <option value="enable">Enable</option>
                                <option value="disable" selected>Disable</option>
                            </select>
                        </td>
                    </tr>
                </table>

                <!-- BLE Warning Section -->
                <div id="ble_warning_div" style="display: none; margin: 8px 0;">
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <span data-lucide="alert-triangle" style="font-size: 16px; margin-right: 8px;"></span>
                            <strong style="color: #92400e; font-size: 14px;">BLE Connection Warning</strong>
                        </div>
                        <div style="color: #78350f; font-size: 13px; line-height: 1.4;">
                            When BLE connects, WiFi AP is disabled. To restore WiFi AP: disconnect BLE and power cycle device.
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="section-title">CAN</div>
                <table class="form-table">
                    <tr>
                        <td>CAN Bitrate:</td>
                        <td>
                            <select name="can_datarate" id="can_datarate">
                                <option value="5K">5K</option>
                                <option value="10K">10K</option>
                                <option value="20K">20K</option>
                                <option value="25K">25K</option>
                                <option value="50K">50K</option>
                                <option value="100K">100K</option>
                                <option value="125K">125K</option>
                                <option value="250K">250K</option>
                                <option value="500K">500K</option>
                                <option value="800K">800K</option>
                                <option value="1000K">1000K</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>CAN Mode:</td>
                        <td>
                            <select name="can_mode" id="can_mode">
                                <option value="normal" selected="selected">Normal</option>
                                <option value="silent">Silent</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Port Type:</td>
                        <td>
                            <select name="port_type" id="port_type">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>TCP/UDP Port:</td>
                        <td>
                            <input type="number" id="tcp_port_value" name="tcp_port_value" value="3333" min="1" max="65535" />
                        </td>
                    </tr>
                    <tr>
                        <td>Protocol:</td>
                        <td>
                            <select name="protocol" id="protocol">
                                <option value="realdash66">realdash66</option>
                                <option value="slcan">slcan</option>
                                <option value="savvycan">savvyCAN</option>
                                <option value="elm327">elm327</option>
                                <option value="auto_pid">AutoPID</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>MQTT:</td>
                        <td>
                            <select name="mqtt_en" id="mqtt_en">
                                <option value="enable">Enable</option>
                                <option value="disable" selected>Disable</option>
                            </select>
                        </td>
                    </tr>
                </table>

                <div id="mqtt_en_div">
                    <div class="divider"></div>
                    <div class="section-title">MQTT</div>
                    <table class="form-table">
                        <tr>
                            <td><label for="mqtt_url"><b>MQTT URL:</b></label></td>
                            <td><input type="text" id="mqtt_url" name="mqtt_url" value="127.0.0.1" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_port"><b>MQTT Port:</b></label></td>
                            <td><input type="number" id="mqtt_port" name="mqtt_port" value="1883" min="1" max="65535" />
                            </td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_user"><b>MQTT User:</b></label></td>
                            <td><input type="text" id="mqtt_user" name="mqtt_user" value="meatpi" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_pass"><b>MQTT Pass:</b></label></td>
                            <td><input type="text" id="mqtt_pass" name="mqtt_pass" value="meatpi" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_tx_topic"><b>TX Topic:</b></label></td>
                            <td><input type="text" id="mqtt_tx_topic" name="mqtt_tx_topic" value="" /></td>
                            <td><input type="checkbox" id="mqtt_tx_en_checkbox" name="mqtt_tx_en_checkbox"
                                    onchange="txCheckBoxChanged()"></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_rx_topic"><b>RX Topic:</b></label></td>
                            <td><input type="text" id="mqtt_rx_topic" name="mqtt_rx_topic" value="" /></td>
                            <td><input type="checkbox" id="mqtt_rx_en_checkbox" name="mqtt_rx_en_checkbox" 
                                    onchange="rxCheckBoxChanged()"></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_status_topic"><b>Status Topic:</b></label></td>
                            <td><input type="text" id="mqtt_status_topic" name="mqtt_status_topic" value="" /></td>
                        </tr>
                        <tr>
                            <td><label for="mqtt_elm327_log"><b>MQTT elm327 log:</b></label></td>
                            <td><select name="mqtt_elm327_log" style="width: 93px;" id="mqtt_elm327_log"
                                    onchange="alert_elm327()">
                                    <option value="enable">Enable</option>
                                    <option value="disable">Disable</option>
                                </select></td>
                        </tr>
                        <tr>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                    </table>
                    <div style="overflow-x:auto;">
                        <div class="section-title">MQTT CAN Filter</div>
                        <table id="can_flt_table" >
                            <tr>
                                <th style="text-align: left;">CAN ID (dec)</th>
                                <th style="text-align: left;">Name</th>
                                <th style="text-align: left;">PID</th>
                                <th style="text-align: left;">Index</th>
                                <th style="text-align: left;">Start Bit</th>
                                <th style="text-align: left;">Bit Length</th>
                                <th style="text-align: left;">Expression</th>
                                <th style="text-align: left;">Cycle ms</th>
                                <th><input id="store_canflt_button" name="store_canflt_button" type="button"
                                        onclick="storeCANFLT()" value="Store" style="width: 100%;" /></th>
                            </tr>
                            <tr>
                                <td style="width: 10%;" ><input type="number" id="canId" min="0" max="536870912" style="width: 80%;"/></td>
                                <td style="width: 20%;"><input type="text" id="name" maxlength="16" style="width: 90%;"/></td>
                                <td style="width: 10%;"><input type="number" id="pid"  style="width: 80%;"/></td>
                                <td style="width: 10%;"><input type="number" id="pindex"  style="width: 80%;"/></td>
                                <td style="width: 10%;"><input type="number" id="startBit" min="0" max="63"  style="width: 80%;"/></td>
                                <td style="width: 10%;"><input type="number" id="bitLength" min="1" max="64" style="width: 80%;"/></td>
                                <td style="width: 20%;"><input type="text" id="expression" maxlength="64"  style="width: 90%;"/></td>
                                <td style="width: 10%;"><input type="number" id="cycle" min="100" max="1000"  style="width: 80%;"/></td>
                                <td><input id="add_row_button" name="add_row_button" type="button" onclick="addCANFLTRow()"
                                        value="Add ID" style="width: 100%;" /></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </form>
        </div>

        <div id="automate" class="tabcontent">
            <div class="section-title">Automate</div>
            <table class="form-table">
                <tr>
                    <td>MQTT HA Discovery:</td>
                    <td>
                        <select id="ha_discovery" name="ha_discovery" onchange="toggleDestinationAndCycle(); toggleSendToFields(); enableAutoStoreButton();submit_enable();">
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Grouping:</td>
                    <td>
                        <select id="grouping" name="grouping" onchange="toggleDestinationAndCycle(); toggleSendToFields(); enableAutoStoreButton();submit_enable();">
                            <option value="disable">Disable</option>
                            <option value="enable">Enable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Destination Type:</td>
                    <td><select id="group_dest_type" name="group_dest_type" onchange="enableAutoStoreButton();submit_enable();">
                        <option value="Default">Default</option>
                        <option value="MQTT_Topic">MQTT Topic</option>
                    </select>
                    </td>
                </tr>
                <tr>
                    <td>Destination:</td>
                    <td>
                        <input type="text" id="destination" name="destination" disabled oninput="enableAutoStoreButton();submit_enable();">
                    </td>
                </tr>
                <tr>
                    <td>Cycle Time(ms):</td>
                    <td>
                        <input type="text" id="group_cycle" name="group_cycle" value="5000" disabled oninput="enableAutoStoreButton();submit_enable();">
                    </td>
                </tr>
            </table>
            <div class="section-title">Standard PIDs</div>
            <table class="form-table">
                <tr>
                    <td>Standard PIDs:</td>
                    <td>
                        <select id="standard_pids" name="standard_pids" onchange="toggleStandardPIDOptions();enableAutoStoreButton();submit_enable();">
                            <option value="disable">Disable</option>
                            <option value="enable">Enable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>ECU Protocol:</td>
                    <td>
                        <select id="ecu_protocol" name="ecu_protocol" onchange="enableAutoStoreButton();submit_enable();">
                            <option value="0">0- Automatic</option>
                            <option value="6">6- ISO 15765-4 (CAN 11bit/500K)</option>
                            <option value="7">7- ISO 15765-4 (CAN 29bit/500K)</option>
                            <option value="8">8- ISO 15765-4 (CAN 11bit/250K)</option>
                            <option value="9">9- ISO 15765-4 (CAN 29bit/250K)</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Available PIDs:</td>
                    <td style="display: flex; align-items: center; gap: 5px;">
                        <select id="available_pids" name="available_pids" disabled 
                                onchange="enableAutoStoreButton();submit_enable();" style="flex: 1;">
                        </select>
                        <button id="add_pid_button" onclick="addSelectedPID()" disabled style="margin-left: 5px;">Add PID</button>
                        <button id="scan_pids_button" onclick="scanAvailablePIDs()" style="margin-left: 5px;">Scan PIDs</button>
                    </td>
                </tr>
                
            </table>
            <div id="standard_pids_table">
                <div class="std-pid-entries"></div>
            </div>
            <div class="section-title">Vehicle Specific</div>
            <table class="form-table">
                <tr>
                    <td>Vehicle Specific:</td>
                    <td>
                        <select id="car_specific" name="car_specific" onchange="toggleCarModel(); toggleDestinationAndCycle(); enableAutoStoreButton();submit_enable();">
                            <option value="disable">Disable</option>
                            <option value="enable">Enable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Vehicle Model:</td>
                    <td style="display: flex; align-items: center; gap: 5px;">
                        <select id="car_model" name="car_model" onchange="enableAutoStoreButton();submit_enable();" style="flex: 1;"></select>
                        <button onclick="fetchVehicleProfiles()" style="margin-left: 5px;">Get Latest</button>
                    </td>
                </tr>
                <tr>
                    <td>Vehicle Profiles:</td>
                    <td>
                        <form id="car_data_form" enctype="multipart/form-data">
                            <input id="car_data_file" name="car_data_file" type="file" onchange="sendCARDataFile();submit_enable();" />
                        </form>
                    </td>
                </tr>
                <tr>
                    <td>Specific Initialisation:</td>
                    <td>
                        <input type="text" id="specific_init" name="specific_init" oninput="enableAutoStoreButton()">
                    </td>
                </tr>
            </table>

            <div id="specific_pids_table">
                <div class="specific-pid-entries"></div>
            </div>


            <div class="section-title">Custom PIDs</div>
            <table class="form-table">
                <tr>
                    <td>Custom Initialisation:</td>
                    <td>
                        <input type="text" id="initialisation" name="initialisation" oninput="enableAutoStoreButton()">
                    </td>
                </tr>
            </table>
            
            <div id="automate_table">
                <div class="pid-entries"></div>
            </div>
            
            <div class="button-group">
                <button onclick="addRowAutoTable()" class="primary-button">New</button>
                <button id="custom_pid_store" onclick="storeAutoTableData()" class="store" disabled>Store</button>
            </div>
        </div>

        <div id="monitor" class="tabcontent">
            <div class="section-title">Monitor Settings</div>
            <table class="form-table">
                <tr>
                    <td>Bitrate</td>
                    <td>Filter</td>
                    <td>Mask</td>
                </tr>
                <tr>
                    <td>
                        <select name="mon_datarate" id="mon_datarate">
                            <option value="10K">10K</option>
                            <option value="20K">20K</option>
                            <option value="50K">50K</option>
                            <option value="100K">100K</option>
                            <option value="125K">125K</option>
                            <option value="250K">250K</option>
                            <option value="500K" selected="selected">500K</option>
                            <option value="800K">800K</option>
                            <option value="1000K">1Mbit</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" id="mon_filter" name="mon_filter" value="00000000" />
                    </td>
                    <td>
                        <input type="text" id="mon_mask" name="mon_mask" value="FFFFFFFF" />
                    </td>
                    <td><input id="mon_button" name="mon_button" type="button" onclick="mon_control()" value="Start"
                        style="font-size: 100%;" /></td>
                </tr>
            </table>
            <div class="divider"></div>
            <table id="table2" class="form-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Len</th>
                        <th>Data</th>
                        <th>Time</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="power_saving_tab" class="tabcontent">
            <div class="section-title">Sleep Mode</div>
            <table class="form-table">
                <tr>
                    <td>Sleep Mode:</td>
                    <td>
                        <select name="sleep_status" id="sleep_status" onChange="toggleSleepWarning();submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Sleep Voltage:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="sleep_volt" 
                               name="sleep_volt" 
                               value="13.2" 
                               min="12.0" 
                               max="15.0" 
                               step="0.1"
                               oninput="document.getElementById('sleep_volt_value').textContent = this.value;submit_enable();">
                        <span id="sleep_volt_value">13.2</span>V
                    </td>
                </tr>
                <tr>
                    <td>Sleep After:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="sleep_time" 
                               name="sleep_time" 
                               value="5" 
                               min="1" 
                               max="30" 
                               step="1"
                               oninput="document.getElementById('sleep_time_value').textContent = this.value;submit_enable();">
                        <span id="sleep_time_value">5</span>min
                    </td>
                </tr>
                <tr>
                    <td>Periodic wake up:</td>
                    <td>
                        <select name="periodic_wakeup" id="periodic_wakeup" onchange="submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr id="wakeup_every_row">
                    <td>Wakeup Every:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="wakeup_interval" 
                               name="wakeup_interval" 
                               value="60" 
                               min="5" 
                               max="240" 
                               step="1"
                               oninput="document.getElementById('wakeup_interval_value').textContent = this.value;submit_enable();">
                        <span id="wakeup_interval_value">60</span>min
                    </td>
                </tr>
                <tr>
                    <td>Battery Alert:</td>
                    <td>
                        <select name="batt_alert" id="batt_alert" onchange="submit_enable();">
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
            </table>
            <div id="batt_alert_div">
                <div class="divider"></div>
                <div class="section-title">Battery Alert</div>
                <table class="form-table">
                    <tr>
                        <td><label for="batt_alert_ssid"><b>SSID:</b></label></td>
                        <td><input type="text" id="batt_alert_ssid" name="batt_alert_ssid" value="MeatPi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_pass"><b>Password:</b></label></td>
                        <td><input type="text" id="batt_alert_pass" name="batt_alert_pass" value="TomatoSauce" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_volt"><b>Alert Voltage:</b></label></td>
                        <td><input type="number" step="0.1" id="batt_alert_volt" name="batt_alert_volt" value="11.0"
                                min="9.0" max="15.0" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_protocol"><b>Alert Protocol:</b></label></td>
                        <td><select name="batt_alert_protocol" style="width: 93px;" id="batt_alert_protocol">
                                <option value="mqtt">MQTT</option>
                            </select></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_url"><b>Alert URL:</b></label></td>
                        <td><input type="text" id="batt_alert_url" name="batt_alert_url" value="127.0.0.1" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_port"><b>Alert Port:</b></label></td>
                        <td><input type="number" id="batt_alert_port" name="batt_alert_port" value="1883" min="1"
                                max="65535" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_mqtt_user"><b>Alert MQTT User:</b></label></td>
                        <td><input type="text" id="batt_mqtt_user" name="batt_mqtt_user" value="meatpi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_mqtt_pass"><b>Alert MQTT Pass:</b></label></td>
                        <td><input type="text" id="batt_mqtt_pass" name="batt_mqtt_pass" value="meatpi" /></td>
                    </tr>
                    <tr>
                        <td><label for="batt_alert_topic"><b>Alert Topic:</b></label></td>
                        <td><input type="text" id="batt_alert_topic" name="batt_alert_topic" value="CAR1/voltage" />
                        </td>
                    </tr>
                    <tr>
                        <td><b>Alert every:</b></td>
                        <td><select name="batt_alert_time" style="width: 93px;" id="batt_alert_time">
                                <option value="1">1hr</option>
                                <option value="6">6hr</option>
                                <option value="12">12hr</option>
                                <option value="24">1day</option>
                            </select></td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                </table>
            </div>

        </div>
        <div id="logger" class="tabcontent">
            <div class="section-title">Logger Settings</div>
            <table class="form-table">
                <tr>
                    <td>Logger:</td>
                    <td>
                        <select name="logger_status" id="logger_status" onChange="submit_enable();">
                            <option value="enable">Enable</option>
                            <option value="disable">Disable</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Log Storage:</td>
                    <td>
                        <select name="log_storage" id="log_storage" onChange="submit_enable();">
                            <option value="sdcard">SDcard</option>
                            <!-- <option value="internal">Internal</option> -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Storage Filesystem:</td>
                    <td>
                        <select name="log_filesystem" id="log_filesystem" onChange="submit_enable();">
                            <option value="fatfs">FATFS</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Log Period:</td>
                    <td class="slider-container">
                        <input type="range" 
                            id="log_period" 
                            name="log_period" 
                            value="60" 
                            min="10" 
                            max="300" 
                            step="1"
                            oninput="document.getElementById('log_period_value').textContent = this.value;submit_enable();">
                        <span id="log_period_value">60</span>sec
                    </td>
                </tr>
            </table>
        </div>
        <div id="advanced_tab" class="tabcontent">
            <div class="section-title">Advanced Settings</div>
            <table class="form-table">
                <tr>
                    <td>Motion Threshold:</td>
                    <td class="slider-container">
                        <input type="range" 
                               id="imu_threshold" 
                               name="imu_threshold" 
                               value="8" 
                               min="1" 
                               max="32" 
                               step="1"
                               oninput="document.getElementById('imu_threshold_value').textContent = (this.value * 3.9).toFixed(1) + ' mg';submit_enable();"
                               onchange="submit_enable();">
                        <span id="imu_threshold_value">31.2 mg</span>
                    </td>
                </tr>
            </table>
        </div>
        <div id="system_tab" class="tabcontent">
            <div class="section-title">System</div>
            <table class="form-table">
                <tr>
                    <td>Reboot WiCAN:</td>
                    <td><input id="reboot_button" name="reboot_button" type="button" onclick="reboot()" value="Reboot" class="system-button" /></td>
                </tr>
                <tr>
                    <td>Download Configuration:</td>
                    <td><input id="download_cfg_butt" name="download_cfg_butt" type="button" onclick="downloadCfg()" value="Download" class="system-button" /></td>
                </tr>
                <tr>
                    <td>Upload Configuration:</td>
                    <td>
                        <input type="button" onclick="document.getElementById('fileInput').click()" value="Upload" class="system-button" />
                        <input type="file" id="fileInput" accept=".json" onchange="uploadCfg()" style="display: none;" />
                    </td>
                </tr>
            </table>
        
            <div class="section-title">Firmware Update</div>
            <div class="description-text">
                Firmware updates are available on <a href="https://github.com/meatpiHQ/wican-fw/releases">GitHub</a>. Instructions are available <a href="https://meatpihq.github.io/wican-fw/config/firmware-update">here</a>.
            </div>
            <form id="ota_form" action="/upload/ota.bin" method="post" enctype="multipart/form-data">
                <table class="form-table">
                    <tr>
                        <td><input id="ota_file" name="ota_file" type="file" accept=".bin" /></td>
                        <td><input id="ota_submit_button" type="button" value="Update" onclick="otaClick()" class="system-button" /></td>
                    </tr>
                </table>
            </form>
        </div>
               
        <div id="about_tab" class="tabcontent">
            <div class="section-title">About</div>
            <table class="form-table">
                <tr>
                    <td>Firmware ver:</td>
                    <td>
                        <div id="fw_version">1.00</div>
                    </td>
                </tr>
                <tr>
                    <td>Hardware ver:</td>
                    <td>
                        <div id="hw_version">v2.10</div>
                    </td>
                </tr>
                <tr>
                    <td>Git ver:</td>
                    <td>
                        <div id="git_version">v2.10</div>
                    </td>
                </tr>
                <tr>
                    <td>Designed By:</td>
                    <td>
                        <div id="made_by"><a href="https://www.meatpi.com/"><b>meatpi.com</b></a></div>
                    </td>
                </tr>
            </table>
        </div>
        <input id="submit_button" name="submit_button" type="button" onclick="postConfig()" value="Submit Changes" disabled />
    </div>
    
    
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById("submit_button").disabled = true;
            setRTCTime();
        });
		let latest_car_models = null;
        let bleAlertShown = false;
        function loadCarModels(data) {
            const carModelSelect = document.getElementById("car_model");
            if (data && Array.isArray(data.supported)) {
				carModelSelect.innerHTML = "";
                data.supported.forEach(model => {
                    const option = document.createElement("option");
                    option.value = model;
                    option.text = model;
                    carModelSelect.appendChild(option);
                });
            } else {
                console.error("Invalid data format or missing 'supported' property.");
            }
			toggleCarModel();
			toggleDestinationAndCycle();
			toggleSendToFields();
            toggleStandardPIDOptions();
            toggleSmartConnectConfig();
        }

        function loadDashboard() {
            window.location.href = '/dashboard.html';
        }

        function setRTCTime() {
            const now = new Date();
            
            function decToBcd(val) {
                return Math.floor(val / 10) * 16 + (val % 10);
            }
            
            const rtcData = {
                command: "set_rtc_time",
                hour: decToBcd(now.getUTCHours()),
                min: decToBcd(now.getUTCMinutes()),
                sec: decToBcd(now.getUTCSeconds()),
                year: decToBcd(now.getUTCFullYear() % 100),
                month: decToBcd(now.getUTCMonth() + 1),
                day: decToBcd(now.getUTCDate()),
                weekday: decToBcd(now.getUTCDay()) 
            };
            
            fetch('/system_commands', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rtcData)
            })
            .then(response => response.text())
            .then(data => {
                console.log('RTC time set successfully (UTC):', data);
            })
            .catch(error => {
                console.error('Error setting RTC time:', error);
            });
        }

        function showNotification(message, color = "red", duration = 5000) {
            const notification = document.getElementById("notification");
            
            switch (color) {
                case "red":
                    notification.style.backgroundColor = "#fee2e2";
                    notification.style.borderColor = "#ef4444";
                    notification.style.color = "#991b1b";
                    break;
                case "green":
                    notification.style.backgroundColor = "#dcfce7";
                    notification.style.borderColor = "#22c55e";
                    notification.style.color = "#166534";
                    break;
                case "blue":
                    notification.style.backgroundColor = "#dbeafe";
                    notification.style.borderColor = "#3b82f6";
                    notification.style.color = "#1e40af";
                    break;
                case "yellow":
                    notification.style.backgroundColor = "#fef9c3";
                    notification.style.borderColor = "#eab308";
                    notification.style.color = "#854d0e";
                    break;
                default:
                    notification.style.backgroundColor = "#fee2e2";
                    notification.style.borderColor = "#ef4444";
                    notification.style.color = "#991b1b";
            }

            notification.innerHTML = message;
            notification.classList.add("show");
            
            if (window.notificationTimeout) {
                clearTimeout(window.notificationTimeout);
            }
            
            window.notificationTimeout = setTimeout(() => {
                notification.classList.remove("show");
            }, duration);
        }
		async function fetchVehicleProfiles() {
			try {
				if (!navigator.onLine) {
					throw new Error('No internet connection');
				}
                
				const response = await fetch('https://raw.githubusercontent.com/meatpiHQ/wican-fw/main/vehicle_profiles.json');
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				const data = await response.json();
				console.log(data);
				latest_car_models = data;
				const carModels = [];
                carModels.push("Not Selected");
				if (data && Array.isArray(data.cars)) {
					data.cars.forEach(car => {
						if (car.car_model) {
							carModels.push(car.car_model);
						}
					});
				}
				console.log(carModels);
				var mod = { "supported": carModels };
				loadCarModels(mod);
				enableAutoStoreButton();
                
			} catch (error) {
				console.error('There was a problem with the fetch operation:', error);
                showNotification("Unable to fetch vehicle_profiles.json. " + error.message, "red");
			}
		}

        function toggleCarModel() {
            const carSpecific = document.getElementById("car_specific").value;
            const carModelSelect = document.getElementById("car_model");
            if (carSpecific === "disable") {
                carModelSelect.disabled = true;
            } else {
                carModelSelect.disabled = false;
            }
			toggleDiscovery();
        }
        function toggleStandardPIDOptions() {
            const standardPidsSelect = document.getElementById("standard_pids");
            const ecuProtocolSelect = document.getElementById("ecu_protocol");
            const availablePidsSelect = document.getElementById("available_pids");
            const scanPidButton = document.getElementById("scan_pids_button");
            
            const isEnabled = standardPidsSelect.value === "enable";
            ecuProtocolSelect.disabled = !isEnabled;
            availablePidsSelect.disabled = !isEnabled;
            scanPidButton.disabled = !isEnabled;
        }

        function toggleSmartConnectConfig() {
            const wifiMode = document.getElementById("wifi_mode").value;
            const smartConnectConfig = document.getElementById("smartconnect_config");
            const stationConfigSection = document.getElementById("station_config_section");
            const protocolSelect = document.getElementById("protocol");
            const addFbBtn = document.getElementById("add_fallback_button");
            const fbRows = document.querySelectorAll('#fallback_rows input, #fallback_rows select, #fallback_rows button');
            
            if (wifiMode === "SmartConnect") {
                smartConnectConfig.style.display = "block";
                stationConfigSection.style.display = "none";
                protocolSelect.disabled = true; 
                
                toggleDriveConfig(); 
                
                if (addFbBtn) addFbBtn.disabled = true;
                fbRows.forEach(el => el.disabled = true);
            } else {
                smartConnectConfig.style.display = "none";
                stationConfigSection.style.display = "block";
                protocolSelect.disabled = false;

                const bleStatus = document.getElementById("ble_status");
                const blePasskey = document.getElementById("ble_pass_value");
                bleStatus.disabled = false;
                blePasskey.disabled = false;
                if (addFbBtn) addFbBtn.disabled = false;
                fbRows.forEach(el => el.disabled = false);
            }
            // Trigger validation when switching modes
            submit_enable();
        }

        function toggleDriveConfig() {
            const wifiMode = document.getElementById("wifi_mode").value;
            const driveConnectionType = document.getElementById("drive_connection_type").value;
            const driveWifiConfig = document.getElementById("drive_wifi_config");
            const driveWifiPassword = document.getElementById("drive_wifi_password");
            const driveWifiSecurity = document.getElementById("drive_wifi_security");
            const bleStatus = document.getElementById("ble_status");
            const blePasskey = document.getElementById("ble_pass_value");
            
            // Only apply SmartConnect logic when in SmartConnect mode
            if (wifiMode === "SmartConnect") {
                if (driveConnectionType === "wifi") {
                    // Show WiFi config, force disable BLE
                    driveWifiConfig.style.display = "table-row";
                    driveWifiPassword.style.display = "table-row";
                    driveWifiSecurity.style.display = "table-row";
                    bleStatus.value = "disable";
                    bleStatus.selectedIndex = 1; // Select "Disable" option
                    bleStatus.disabled = true;
                    blePasskey.disabled = true;
                } else if (driveConnectionType === "ble") {
                    // Hide WiFi config, force enable BLE
                    driveWifiConfig.style.display = "none";
                    driveWifiPassword.style.display = "none";
                    driveWifiSecurity.style.display = "none";
                    bleStatus.value = "enable";
                    bleStatus.selectedIndex = 0; // Select "Enable" option
                    bleStatus.disabled = true;
                    blePasskey.disabled = false;
                }
            }
            // Trigger validation when changing drive connection type
            submit_enable();
        }

        function toggleDestinationAndCycle() {
			const grouping = document.getElementById("grouping").value;
			const destinationField = document.getElementById("destination");
			const cycleField = document.getElementById("group_cycle");
            const groupDestTypeFeild = document.getElementById("group_dest_type");
			
			if (grouping === "enable") {
				destinationField.disabled = false;
				cycleField.disabled = false;
                groupDestTypeFeild.disabled = false;
			} else {
				destinationField.disabled = true;
				cycleField.disabled = true;
                groupDestTypeFeild.disabled = true;
			}
        }
		
		function toggleDiscovery() {
			const carSpecific = document.getElementById("car_specific").value;
			const discovery = document.getElementById("ha_discovery");

			discovery.disabled = true;
			discovery.value = "disable";
		}
		
        function txCheckBoxChanged() {
            if (document.getElementById("mqtt_tx_en_checkbox").checked) {
                document.getElementById("mqtt_tx_topic").disabled = false;
            } else {
                document.getElementById("mqtt_tx_topic").disabled = true;
            }
        }

        function rxCheckBoxChanged() {
            if (document.getElementById("mqtt_rx_en_checkbox").checked) {
                document.getElementById("mqtt_rx_topic").disabled = false;
            } else {
                document.getElementById("mqtt_rx_topic").disabled = true;
            }
        }

        // Fallback Networks UI helpers
        function renderFallbackNetworks(list) {
            const container = document.getElementById('fallback_rows');
            if (!container) return;
            container.innerHTML = '';
            const limited = Array.isArray(list) ? list.slice(0,5) : [];
            limited.forEach(item => addFallbackNetworkRow(item));
            updateAddFallbackButtonState();
        }

        function addFallbackNetworkRow(data = {}) {
            const container = document.getElementById('fallback_rows');
            if (!container) return;
            const current = container.querySelectorAll('.fallback-row').length;
            if (current >= 5) return;

            const row = document.createElement('div');
            row.className = 'fallback-row';
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '1fr 1fr 120px auto';
            row.style.gap = '8px';
            row.style.margin = '6px 0';

            row.innerHTML = `
                <input type="text" class="fb-ssid" placeholder="SSID" value="${(data.ssid||'').replace(/"/g,'&quot;')}" oninput="submit_enable();" />
                <input type="text" class="fb-pass" placeholder="Password" value="${(data.pass||data.password||'').replace(/"/g,'&quot;')}" oninput="submit_enable();" />
                <select class="fb-sec" onchange="submit_enable();">
                    <option value="wpa3" ${((data.security||'wpa3')==='wpa3')?'selected':''}>WPA3</option>
                    <option value="wpa2" ${((data.security||'wpa3')==='wpa2')?'selected':''}>WPA2</option>
                </select>
                <button type="button" class="fb-remove" onclick="removeFallbackRow(this)">Remove</button>
            `;
            container.appendChild(row);
            updateAddFallbackButtonState();
            submit_enable();
        }

        function removeFallbackRow(btn) {
            const row = btn.closest('.fallback-row');
            if (row) row.remove();
            updateAddFallbackButtonState();
            submit_enable();
        }

        function updateAddFallbackButtonState() {
            const addBtn = document.getElementById('add_fallback_button');
            if (!addBtn) return;
            const count = document.querySelectorAll('#fallback_rows .fallback-row').length;
            addBtn.disabled = count >= 5 || document.getElementById('wifi_mode').value === 'SmartConnect';
        }

		function sendCARDataFile() {
			const fileInput = document.getElementById("car_data_file");
			const maxFileSize = 200 * 1024; 

			if (fileInput.files.length == 0) {
                showNotification("No files selected!", "red");
				alert("No files selected!");
			} else {
				const file = fileInput.files[0];

				if (file.size > maxFileSize) {
                    showNotification("File size exceeds 200KB!", "red");
					alert("File size exceeds 200KB!");
					return;
				}

				const reader = new FileReader();
				reader.onload = function(event) {
					try {
                        const jsonData = JSON.parse(event.target.result);
                        const formattedData = jsonData.car_model ? { cars: [jsonData] } : jsonData;
                        const unformattedJson = JSON.stringify(formattedData).replace(/\s+/g, '');
                        
                        const form = document.getElementById('car_data_form');
                        const formData = new FormData(form);
                        formData.set('car_data_file', new Blob([unformattedJson], {type: 'application/json'}));
                        latest_car_models = null;
                        
                        fetch('/upload/car_data.json', {
                            method: 'POST',
                            body: formData
                        })
						.then(response => response.text())
						.then(data => {
							console.log('Success:', data);
                            showNotification(data, "green");
							setTimeout(() => {
								window.location.reload();
							}, 1000);
						})
						.catch(error => {
							console.error('Error:', error);
						});
					} catch (e) {
                        showNotification("Invalid JSON file!", "red");
						alert("The selected file is not a valid JSON file!");
					}
				};
				reader.readAsText(file);
			}
		}

        function addRowAutoTable() {
            addCollapsibleRow();
            enableAutoStoreButton();
        }

    async function scanAvailablePIDs() {
        const scanButton = document.querySelector('#scan_pids_button');
        const addButton = document.querySelector('#add_pid_button');
        
        try {
            scanButton.disabled = true;
            scanButton.textContent = "Scanning...";
            addButton.disabled = true;

            const ecuProtocol = document.getElementById('ecu_protocol').value;
            const response = await fetch(`/scan_available_pids?protocol=${ecuProtocol}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const pidSelect = document.getElementById('available_pids');
            pidSelect.innerHTML = '';
            if (data.text) {
                showNotification(data.text, "red");
            } else if (data.std_pids && Array.isArray(data.std_pids) && data.std_pids.length > 0) {
                data.std_pids.forEach(pid => {
                    const option = document.createElement('option');
                    option.value = pid;
                    option.textContent = pid;
                    pidSelect.appendChild(option);
                });
                addButton.disabled = false;
                showNotification("PID scan complete", "green");
            } else {
                showNotification("No PIDs found. Try a different protocol or check if ignition is ON", "orange");
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification("PID scan failed: " + error.message, "red");
        } finally {
            scanButton.disabled = false;
            scanButton.textContent = "Scan PIDs";
        }
    }

    const pidEntryStyles = `
        .pid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            margin-top: 0.5rem;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
        }
        
        .header-right {
            display: flex;
            gap: 0.5rem;
        }
        
        .collapse-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem 0.5rem;
            color: var(--gray-700);
        }
        
        .pid-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transition: height 0.3s ease;
        }
        
        .pid-content.hidden {
            display: none;
        }
    `;
    function addCollapsibleRow(rowData = {}) {
        const container = document.querySelector('.pid-entries');
        const entry = document.createElement('div');
        entry.className = 'pid-entry';

        entry.innerHTML = `
            <div class="pid-header">
                <div class="header-left">
                    <button type="button" class="collapse-btn">▼</button>
                    <span class="pid-title">New PID</span>
                </div>
                <div class="header-right">
                    <button type="button" class="delete-btn">Delete</button>
                </div>
            </div>
            <div class="pid-content hidden">
                <table class="compact-form-table">
                    <tr>
                        <td>Name:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                        <td><input type="text" class="name-input" value="${rowData.Name || ''}" 
                            placeholder="Parameter Name"></td>
                    </tr>
                    <tr>
                        <td>Init:</td>
                        <td><input type="text" class="init-input" value="${rowData.Init || ''}" 
                            placeholder="PID Init"></td>
                    </tr>
                    <tr>
                        <td>PID:</td>
                        <td><input type="text" class="pid-input" value="${rowData.PID || ''}" 
                            placeholder="PID"></td>
                    </tr>
                    <tr>
                        <td>Expression:</td>
                        <td><input type="text" class="expression-input" value="${rowData.Expression || ''}" 
                            placeholder="Enter expression"></td>
                    </tr>
                    <tr>
                        <td>Min Value:</td>
                        <td><input type="number" class="min-value-input" value="${rowData.MinValue || ''}" 
                            step="0.01" placeholder="Minimum value"></td>
                    </tr>
                    <tr>
                        <td>Max Value:</td>
                        <td><input type="number" class="max-value-input" value="${rowData.MaxValue || ''}" 
                            step="0.01" placeholder="Maximum value"></td>
                    </tr>
                    <tr>
                        <td>Period(ms):</td>
                        <td><input type="number" class="period-input" value="${rowData.Period || ''}" 
                            placeholder="ms"></td>
                    </tr>
                    <tr>
                        <td>Destination Type:</td>
                        <td><select class="type-select">
                            <option value="Default" ${rowData.Type === 'Default' ? 'selected' : ''}>Default</option>
                            <option value="MQTT_Topic" ${rowData.Type === 'MQTT_Topic' ? 'selected' : ''}>MQTT_Topic</option>
                            <option value="MQTT_WallBox" ${rowData.Type === 'MQTT_WallBox' ? 'selected' : ''}>MQTT_WallBox</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>Send_to:</td>
                        <td><input type="text" class="send-to-input" value="${rowData.Send_to || ''}"
                            placeholder="Enter destination"></td>
                    </tr>
                </table>
            </div>
        `;
    console.log("addCollapsibleRow:", rowData);
    console.log("Send_to value:", rowData.Send_to);
    const style = document.createElement('style');
    style.textContent = pidEntryStyles;
    document.head.appendChild(style);
    const header = entry.querySelector('.pid-header');
    const deleteBtn = entry.querySelector('.delete-btn');
    const collapseBtn = entry.querySelector('.collapse-btn');
    const content = entry.querySelector('.pid-content');
    const parameterTitle = entry.querySelector('.pid-title');
    const nameInput = entry.querySelector('.name-input');
    const pidInput = entry.querySelector('.pid-input');

    deleteBtn.addEventListener('click', () => {
        entry.remove();
        enableAutoStoreButton();
    });

    const toggleCollapse = (e) => {
        e.stopPropagation();
        const isHidden = content.style.display === 'none' || getComputedStyle(content).display === 'none';
        content.style.display = isHidden ? 'block' : 'none';
        collapseBtn.textContent = isHidden ? '▲' : '▼';
    };

    header.addEventListener('click', toggleCollapse);
    collapseBtn.addEventListener('click', toggleCollapse);

    parameterTitle.textContent = rowData.Name ? rowData.Name : 'New PID';
    const updateTitle = () => {
        parameterTitle.textContent = `${nameInput.value || 'New Parameter'}`;
    };

    nameInput.addEventListener('input', updateTitle);
    pidInput.addEventListener('input', updateTitle);

    entry.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('input', enableAutoStoreButton);
    });

    container.appendChild(entry);
}

function addSelectedPID(rowData = {}) {
    const pidSelect = document.getElementById('available_pids');
    const selectedPID = rowData.Name || pidSelect.value;
    
    if (selectedPID) {
        const container = document.querySelector('.std-pid-entries');
        const entry = document.createElement('div');
        entry.className = 'std-pid-entry';

        entry.innerHTML = `
            <div class="pid-header">
                <div class="header-left">
                    <button type="button" class="collapse-btn">▼</button>
                    <span class="pid-title">${selectedPID}</span>
                </div>
                <div class="header-right">
                    <button type="button" class="delete-btn">Delete</button>
                </div>
            </div>
            <div class="pid-content" style="display: none;">
                <table class="compact-form-table">
                    <tr>
                        <td>Name:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                        <td><input type="text" class="name-input" value="${selectedPID}" readonly></td>
                    </tr>
                    <tr>
                        <td>Receive Header:</td>
                        <td><input type="text" class="receive-header-input" value="${rowData.ReceiveHeader || ''}" 
                            placeholder="Optional Receive Header" maxlength="8"></td>
                    </tr>
                    <tr>
                        <td>Period(ms):</td>
                        <td><input type="number" class="period-input" value="${rowData.Period || '1000'}" 
                            min="100" max="120000"></td>
                    </tr>
                    <tr>
                        <td>Destination Type:</td>
                        <td><select class="type-select">
                            <option value="Default" ${rowData.Type === 'Default' ? 'selected' : ''}>Default</option>
                            <option value="MQTT_Topic" ${rowData.Type === 'MQTT_Topic' ? 'selected' : ''}>MQTT_Topic</option>
                            <option value="MQTT_WallBox" ${rowData.Type === 'MQTT_WallBox' ? 'selected' : ''}>MQTT_WallBox</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>Destination:</td>
                        <td><input type="text" class="send-to-input" value="${rowData.Send_to || ''}" 
                            placeholder="Enter destination"></td>
                    </tr>
                </table>
            </div>
        `;


        const style = document.createElement('style');
        style.textContent = pidEntryStyles;
        document.head.appendChild(style);
        const header = entry.querySelector('.pid-header');
        const deleteBtn = entry.querySelector('.delete-btn');
        const collapseBtn = entry.querySelector('.collapse-btn');
        const content = entry.querySelector('.pid-content');

        deleteBtn.addEventListener('click', () => {
            entry.remove();
            enableAutoStoreButton();
        });

        const toggleCollapse = (e) => {
            e.stopPropagation();
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            collapseBtn.textContent = isHidden ? '▲' : '▼';
        };

        header.addEventListener('click', toggleCollapse);
        collapseBtn.addEventListener('click', toggleCollapse);

        entry.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', enableAutoStoreButton);
        });

        container.appendChild(entry);
        enableAutoStoreButton();
    }
}

function addCarParameter(rowData = {}) {
    if (rowData.name) {
        const container = document.querySelector('.specific-pid-entries');
        const entry = document.createElement('div');
        entry.className = 'specific-pid-entry';

        entry.innerHTML = `
            <div class="pid-header">
                <div class="header-left">
                    <button type="button" class="collapse-btn">▼</button>
                    <span class="pid-title">${rowData.name}</span>
                </div>
                <div class="header-right">
                    <button type="button" class="delete-btn">Delete</button>
                </div>
            </div>
            <div class="pid-content" style="display: none;">
                <table class="compact-form-table">
                    <tr>
                        <td>Name:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                        <td><input type="text" class="name-input" value="${rowData.name}"></td>
                    </tr>
                    <tr>
                        <td>PID:</td>
                        <td><input type="text" class="pid-input" value="${rowData.pid || ''}" placeholder="PID"></td>
                    </tr>
                    <tr>
                        <td>PID Init:</td>
                        <td><input type="text" class="pid-init-input" value="${rowData.pid_init || ''}" placeholder="Init"></td>
                    </tr>
                    <tr>
                        <td>Expression:</td>
                        <td><input type="text" class="expression-input" value="${rowData.expression || ''}" placeholder="Expression"></td>
                    </tr>
                    <tr>
                        <td>Unit:</td>
                        <td><input type="text" class="unit-input" value="${rowData.unit || ''}" placeholder="Unit"></td>
                    </tr>
                    <tr>
                        <td>Class:</td>
                        <td><input type="text" class="class-input" value="${rowData.class || ''}" placeholder="Class"></td>
                    </tr>

                    <tr>
                        <td>Min Value:</td>
                        <td><input type="number" class="min-input" value="${rowData.min || ''}" step="0.01" placeholder="Min"></td>
                    </tr>
                    <tr>
                        <td>Max Value:</td>
                        <td><input type="number" class="max-input" value="${rowData.max || ''}" step="0.01" placeholder="Max"></td>
                    </tr>
                    <tr>
                        <td>Period(ms):</td>
                        <td><input type="number" class="period-input" value="${rowData.period || '5000'}" min="100" max="60000"></td>
                    </tr>
                    <tr>
                        <td>Destination Type:</td>
                        <td><select class="type-select">
                            <option value="Default" ${rowData.type === 'Default' ? 'selected' : ''}>Default</option>
                            <option value="MQTT_Topic" ${rowData.type === 'MQTT_Topic' ? 'selected' : ''}>MQTT_Topic</option>
                            <option value="MQTT_WallBox" ${rowData.type === 'MQTT_WallBox' ? 'selected' : ''}>MQTT_WallBox</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>Destination:</td>
                        <td><input type="text" class="send-to-input" value="${rowData.send_to || ''}" 
                            placeholder="Destination"></td>
                    </tr>
                </table>
            </div>
        `;



        const style = document.createElement('style');
        style.textContent = pidEntryStyles;
        document.head.appendChild(style);
        const header = entry.querySelector('.pid-header');
        const deleteBtn = entry.querySelector('.delete-btn');
        const collapseBtn = entry.querySelector('.collapse-btn');
        const content = entry.querySelector('.pid-content');

        deleteBtn.addEventListener('click', () => {
            entry.remove();
            enableAutoStoreButton();
        });

        const toggleCollapse = (e) => {
            e.stopPropagation();
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            collapseBtn.textContent = isHidden ? '▲' : '▼';
        };

        header.addEventListener('click', toggleCollapse);
        collapseBtn.addEventListener('click', toggleCollapse);

        entry.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', enableAutoStoreButton);
        });

        container.appendChild(entry);
        enableAutoStoreButton();
    }
}

function loadAutoTable(jsonData) {
        try {
            console.log("Raw jsonData:", jsonData);
            const data = jsonData;

            const initialisationElement = document.getElementById("initialisation");
            if (initialisationElement) {
                initialisationElement.value = data.initialisation || '';
            }

            const automateTable = document.getElementById("automate_table");
            if (!automateTable) {
                console.error("Automate table not found");
                return;
            }

            const setElementValue = (id, value, defaultValue = '') => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value || defaultValue;
                }
            };

            setElementValue("car_specific", data.car_specific, 'disable');
            setElementValue("ha_discovery", 'disable');
            setElementValue("grouping", data.grouping, 'disable');
            setElementValue("group_cycle", data.cycle, '5000');
            setElementValue("destination", data.destination, '');
            setElementValue("car_model", data.car_model, '');
            setElementValue("standard_pids", data.standard_pids, 'disable');
            setElementValue("ecu_protocol", data.ecu_protocol, '6');
            setElementValue("group_dest_type", data.group_dest_type, 'Default');
            
            if (data.pids && Array.isArray(data.pids)) {
                data.pids.forEach((pidData, index) => {
                    console.log(`Loading PID ${index}:`, pidData);
                    addCollapsibleRow({
                        Name: pidData.Name || '',
                        Init: pidData.Init || '',
                        PID: pidData.PID || '',
                        Expression: pidData.Expression || '',
                        MinValue: pidData.MinValue || '',
                        MaxValue: pidData.MaxValue || '',
                        Period: pidData.Period || '',
                        Type: pidData.Type || 'Default',
                        Send_to: pidData.Send_to || ''
                    });
                });
            }

            if (data.std_pids && Array.isArray(data.std_pids)) {
                data.std_pids.forEach((pidData, index) => {
                    console.log(`Loading Standard PID ${index}:`, pidData);
                    addSelectedPID({
                        Name: pidData.Name || '',
                        ReceiveHeader: pidData.ReceiveHeader || '',
                        Period: pidData.Period || '',
                        Type: pidData.Type || 'Default',
                        Send_to: pidData.Send_to || ''
                    });
                });
            }

            requestAnimationFrame(() => {
                try {
                    const carSpecificElement = document.getElementById("car_specific");
                    if (carSpecificElement) {
                        carSpecificElement.dispatchEvent(new Event('change'));
                    }

                    const groupingElement = document.getElementById("grouping");
                    if (groupingElement) {
                        groupingElement.dispatchEvent(new Event('change'));
                    }

                    const groupDestTypeElement = document.getElementById("group_dest_type");
                    if (groupDestTypeElement) {
                        groupDestTypeElement.dispatchEvent(new Event('change'));
                    }

                    const ecuProtocolElement = document.getElementById("ecu_protocol");
                    if (ecuProtocolElement) {
                        ecuProtocolElement.dispatchEvent(new Event('change'));
                    }

                    const standardPidsElement = document.getElementById("standard_pids");
                    if (standardPidsElement) {
                        standardPidsElement.dispatchEvent(new Event('change'));
                    }

                    if (typeof toggleCarModel === 'function') toggleCarModel();
                    if (typeof toggleDestinationAndCycle === 'function') toggleDestinationAndCycle();
                    if (typeof toggleSendToFields === 'function') toggleSendToFields();
                    if (typeof toggleStandardPIDOptions === 'function') toggleStandardPIDOptions();
                } catch (error) {
                    console.error('Error in UI updates:', error);
                }
            });
            console.log("loadAutoTable completed successfully");

        } catch (error) {
            console.error('Error in loadAutoTable:', error);
            showNotification("Error loading table data: " + error.message, "red");
        }
    }


    function enableAutoStoreButton() {
        const storeButton = document.querySelector('button.store');
        if (storeButton) {
            storeButton.disabled = false;
        }
        document.getElementById("custom_pid_store").disabled = false;
    }
		
    async function storeAutoTableData() {
        try {
            const custom_pid_data = [];
            const std_pid_data = [];

            const entries = document.querySelectorAll('.pid-entry');
            const standardEntries = document.querySelectorAll('.std-pid-entry');

            const initialisationValue = document.getElementById("initialisation")?.value || '';
            const groupingValue = document.getElementById("grouping")?.value || 'disable';
            const groupDestTypeValue = document.getElementById("group_dest_type")?.value || 'Default';
            const ha_discoveryValue = document.getElementById("ha_discovery")?.value || 'disable';
            const destinationValue = document.getElementById("destination")?.value || '';
            const cycleField = document.getElementById("group_cycle");
            const cycleValue = cycleField?.value || '5000';
            const carSpecificValue = document.getElementById("car_specific")?.value || 'disable';
            const carModelField = document.getElementById("car_model");
            const standard_pidsValue = document.getElementById("standard_pids")?.value || 'disable';
            const ecu_protocolValue = document.getElementById("ecu_protocol")?.value || '6';
            const carModelValue = carModelField?.value || '';
            if (carSpecificValue== "enable" && (!carModelValue || carModelValue.length === 0 || carModelValue === "Not Selected")) {
                throw new Error("Car model must be selected");
            }

            let carData = {
                car_model: carModelValue,
                init: document.getElementById("specific_init").value,
                pids: []
            };

            const specificPidEntries = document.querySelectorAll('.specific-pid-entry');
            if (specificPidEntries.length > 0) {
                carData.pids = Array.from(specificPidEntries).map(entry => {
                    return {
                        pid: entry.querySelector('.pid-input').value,
                        pid_init: entry.querySelector('.pid-init-input').value,
                        parameters: [{
                            name: entry.querySelector('.name-input').value,
                            expression: entry.querySelector('.expression-input').value,
                            unit: entry.querySelector('.unit-input').value,
                            class: entry.querySelector('.class-input').value,
                            period: entry.querySelector('.period-input').value,
                            min: entry.querySelector('.min-input').value,
                            max: entry.querySelector('.max-input').value,
                            type: entry.querySelector('.type-select').value,
                            send_to: entry.querySelector('.send-to-input').value
                        }]
                    };
                });
            }
            
            fetch('/store_car_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cars: [carData] })
            }).then(response => response.text())
            .then(data => console.log('Success:', data))
            .catch(error => console.error('Error:', error));



            if (!cycleField.disabled && (!/^\d+$/.test(cycleValue) || parseInt(cycleValue) < 1000)) {
                showNotification("Cycle must be a number greater than 1000", "red");
                return false;
            }

            if(entries?.length) {
                entries.forEach((entry, index) => {
                    const pidData = {
                        Name: entry.querySelector('.name-input')?.value || '',
                        Init: entry.querySelector('.init-input')?.value || '',
                        PID: entry.querySelector('.pid-input')?.value || '',
                        Expression: entry.querySelector('.expression-input')?.value || '',
                        MinValue: entry.querySelector('.min-value-input')?.value || '',
                        MaxValue: entry.querySelector('.max-value-input')?.value || '',
                        Period: entry.querySelector('.period-input')?.value || '',
                        Type: entry.querySelector('.type-select')?.value || 'Default',
                        Send_to: entry.querySelector('.send-to-input')?.value || ''
                    };

                    if (pidData.Name.length === 0 || pidData.Name.length >= 32) {
                        throw new Error("Name must not be empty and must be less than 32 characters");
                    }
                    if (pidData.PID.length === 0 || pidData.PID.length >= 10) {
                        throw new Error("PID must not be empty and must be less than 10 characters");
                    }
                    if (pidData.Expression.length === 0 || pidData.Expression.length >= 64) {
                        throw new Error("Expression must not be empty and must be less than 64 characters");
                    }
                    if (!/^\d+$/.test(pidData.Period) || (parseInt(pidData.Period) < 100 && parseInt(pidData.Period) != 0)) {
                        throw new Error("Period must be a number greater than 100");
                    }
                    if (pidData.Send_to.length >= 64) {
                        throw new Error("Send_to must be less than 64 characters");
                    }
                    custom_pid_data.push(pidData);
                });
            }

            if(standardEntries?.length) {
                standardEntries.forEach((entry, index) => {
                    const stdPIDData = {
                        Name: entry.querySelector('.name-input')?.value || '',
                        ReceiveHeader: entry.querySelector('.receive-header-input')?.value || '',
                        Period: entry.querySelector('.period-input')?.value || '',
                        Type: entry.querySelector('.type-select')?.value || 'Default',
                        Send_to: entry.querySelector('.send-to-input')?.value || ''
                    };

                    if (stdPIDData.Name.length === 0 || stdPIDData.Name.length >= 32) {
                        throw new Error("Name must not be empty and must be less than 32 characters");
                    }
                    if (!/^\d+$/.test(stdPIDData.Period) || (parseInt(stdPIDData.Period) < 1000 && parseInt(stdPIDData.Period) != 0)) {
                        throw new Error("Period must be a number greater than 1000");
                    }
                    if (stdPIDData.Send_to.length >= 64) {
                        throw new Error("Send_to must be less than 64 characters");
                    }
                    std_pid_data.push(stdPIDData);
                });
            }            
            
            const jsonData = {
                initialisation: initialisationValue,
                grouping: groupingValue,
                group_dest_type: groupDestTypeValue,
                destination: destinationValue,
                cycle: cycleValue,
                car_specific: carSpecificValue,
                ha_discovery: ha_discoveryValue,
                car_model: carModelValue,
                pids: custom_pid_data,
                std_pids: std_pid_data,
                standard_pids: standard_pidsValue,
                ecu_protocol: ecu_protocolValue
            };

            await fetch('store_auto_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.text())
            .then(result => {
                showNotification("Settings saved successfully", "green");
                document.querySelector(".store").disabled = true;
                document.getElementById("custom_pid_store").disabled = true;
            })
            .catch(error => {
                showNotification("Error saving settings: " + error.message, "red");
                return false;
            });

            return true;

        } catch (error) {
            showNotification(error.message, "red");
            return false;
        }
    }

    function toggleDestinationField() {
        const groupingValue = document.getElementById("grouping").value;
        toggleDestinationAndCycle();  
    }

    function toggleSendToFields() {
        const groupingValue = document.getElementById("grouping")?.value || 'disable';
        const table = document.getElementById("automate_table");
        if (!table) return;

        const rows = table.getElementsByClassName('pid-entry');
        if (!rows.length) return;

        Array.from(rows).forEach(row => {
            const sendToInput = row.querySelector('.send-to-input');
            if (sendToInput) {
                sendToInput.disabled = (groupingValue === "Group ALL");
            }
        });
    }

	var canData = [];

	function restoreCANFLTRow(id, n, p, pi, s, b, e, c) {
		var canId = id;
		if(canId < 0) {
			canId = 0;
		} else if(canId > 536870912) {
			canId = 536870912;
		}
		var name = n;
		var pid = p;
		var pindex = pi;
		var startBit = s;
		var bitLength = b;
		var expression = e;
		var cycle = c;
		var table = document.getElementById("can_flt_table");
		var row = table.insertRow(-1);
		var cell1 = row.insertCell(0);
		var cell2 = row.insertCell(1);
		var cell3 = row.insertCell(2);
		var cell4 = row.insertCell(3);
		var cell5 = row.insertCell(4);
		var cell6 = row.insertCell(5);
		var cell7 = row.insertCell(6);
		var cell8 = row.insertCell(7);
		var cell9 = row.insertCell(8);
		cell1.innerHTML = canId;
		cell2.innerHTML = name;
		cell3.innerHTML = pid;
		cell4.innerHTML = pindex;
		cell5.innerHTML = startBit;
		cell6.innerHTML = bitLength;
		cell7.innerHTML = expression;
		cell8.innerHTML = cycle;
		cell9.innerHTML = '<button style="width: 100%;" onclick="deleteCANFLTRow(this)">Delete</button>';
		canData.push({
			CANID: canId,
			Name: name,
			PID: pid,
			PIDIndex: pindex,
			StartBit: startBit,
			BitLength: bitLength,
			Expression: expression,
			Cycle: cycle
		});
		document.getElementById("canId").value = "";
		document.getElementById("name").value = "";
		document.getElementById("pid").value = "";
		document.getElementById("pindex").value = "";
		document.getElementById("startBit").value = "";
		document.getElementById("bitLength").value = "";
		document.getElementById("expression").value = "";
		document.getElementById("cycle").value = "";
	}

    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for(i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for(i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
        
        if (tabName === 'dashboard_tab') {
            loadDashboard();
        }
    }

	function sta_enable() {}

    // Helper function to get DOM elements efficiently
    function getElements() {
        return {
            wifiMode: document.getElementById("wifi_mode"),
            wifiScanButton: document.getElementById("wifi_scan_button"),
            ssidValue: document.getElementById("ssid_value"),
            passValue: document.getElementById("pass_value"),
            staSecurity: document.getElementById("sta_security"),
            bleStatus: document.getElementById("ble_status"),
            apAutoDisable: document.getElementById("ap_auto_disable"),
            bleWarningDiv: document.getElementById("ble_warning_div"),
            mqttEn: document.getElementById("mqtt_en"),
            mqttEnDiv: document.getElementById("mqtt_en_div"),
            battAlert: document.getElementById("batt_alert"),
            battAlertDiv: document.getElementById("batt_alert_div"),
            submitButton: document.getElementById("submit_button"),
            apPassValue: document.getElementById("ap_pass_value"),
            mqttTxTopic: document.getElementById("mqtt_tx_topic"),
            mqttRxTopic: document.getElementById("mqtt_rx_topic"),
            mqttStatusTopic: document.getElementById("mqtt_status_topic"),
            tcpPortValue: document.getElementById("tcp_port_value"),
            battAlertPort: document.getElementById("batt_alert_port"),
            blePassValue: document.getElementById("ble_pass_value"),
            sleepVolt: document.getElementById("sleep_volt"),
            sleepStatus: document.getElementById("sleep_status"),
            sleepDisableAgree: document.getElementById("sleep_disable_agree"),
            protocol: document.getElementById("protocol"),
            portType: document.getElementById("port_type"),
            mqttElm327Log: document.getElementById("mqtt_elm327_log"),
            periodicWakeup: document.getElementById("periodic_wakeup"),
            wakeupEveryRow: document.getElementById("wakeup_every_row")
        };
    }

    // Helper function to validate field length
    function validateLength(value, min, max, fieldName) {
        const length = value.length;
        return length >= min && length <= max;
    }

    // Helper function to validate port number
    function validatePort(value) {
        const port = parseInt(value);
        return port >= 1 && port <= 65535;
    }

    // Helper function to disable submit button with error message
    function disableSubmitWithError(message) {
        showNotification(message, "red");
        return false;
    }

    function submit_enable() {
        console.log("submit_enable");
        const elements = getElements();
        const wifiMode = elements.wifiMode.value;
        
        // Configure WiFi mode-specific settings
        configureWifiModeSettings(elements, wifiMode);
        
        // Handle BLE status and warnings
        handleBleStatus(elements);
        
        // Validate form and enable/disable submit button
        const isValid = validateForm(elements, wifiMode);
        elements.submitButton.disabled = !isValid;
        
        // Configure protocol-specific settings
        configureProtocolSettings(elements);
        
        // Configure sleep and battery alert settings
        configureSleepSettings(elements);
        
        // Configure MQTT and battery alert visibility
        configureMqttAndBatteryAlerts(elements);
        
        // Configure periodic wakeup settings
        configurePeriodicWakeup(elements);
    }

    function configureWifiModeSettings(elements, wifiMode) {
        const isAP = wifiMode === "AP";
        const isSmartConnect = wifiMode === "SmartConnect";
        
        // Set station fields
        elements.ssidValue.disabled = isAP;
        elements.passValue.disabled = isAP;
        elements.staSecurity.disabled = isAP;
        elements.apAutoDisable.disabled = isAP;
        elements.wifiScanButton.disabled = isAP;
        
        // Set BLE settings based on mode
        if (isAP) {
            elements.bleStatus.disabled = false;
        } else if (isSmartConnect) {
            elements.bleStatus.disabled = true;
        } else {
            elements.bleStatus.disabled = true;
            elements.bleStatus.value = "disable";
            elements.bleStatus.selectedIndex = 1;
            elements.blePassValue.disabled = true;
        }
    }

    function handleBleStatus(elements) {
        const isBleEnabled = elements.bleStatus.value === "enable";
        
        elements.bleWarningDiv.style.display = isBleEnabled ? "block" : "none";
        
        if (isBleEnabled && !window.bleAlertShown) {
            elements.mqttEn.value = "disable";
            elements.mqttEnDiv.style.display = "none";
            elements.mqttEn.disabled = true;
            elements.battAlert.value = "disable";
            elements.battAlertDiv.style.display = "none";
            elements.battAlert.disabled = true;
            window.bleAlertShown = true;
        } else if (!isBleEnabled) {
            elements.mqttEn.disabled = false;
            elements.battAlert.disabled = true;
        }
    }

    function validateForm(elements, wifiMode) {
        // Password validation
        const apPassLen = elements.apPassValue.value.length;
        const passLen = elements.passValue.value.length;
        if ((apPassLen < 8 || apPassLen > 63) || (passLen < 8 || passLen > 63)) {
            return disableSubmitWithError("AP/Station password length, min=8 max=63");
        }
        
        // SSID validation
        if (!validateLength(elements.ssidValue.value, 1, 32)) {
            return disableSubmitWithError("AP/Station SSID length, min=1 max=32");
        }
        
        // MQTT topics validation - only validate if MQTT is enabled
        const isMqttEnabled = elements.mqttEn.value === "enable";
        if (isMqttEnabled) {
            if (!validateLength(elements.mqttTxTopic.value, 1, 64)) {
                return disableSubmitWithError("MQTT TX Topic length, min=1 max=64");
            }
            if (!validateLength(elements.mqttRxTopic.value, 1, 64)) {
                return disableSubmitWithError("MQTT RX Topic length, min=1 max=64");
            }
            if (!validateLength(elements.mqttStatusTopic.value, 1, 64)) {
                return disableSubmitWithError("MQTT Status Topic length, min=1 max=64");
            }
        }
        
        // Port validation
        if (!validatePort(elements.tcpPortValue.value)) {
            return disableSubmitWithError("TCP Port value, min=1 max=65535");
        }
        if (!validatePort(elements.battAlertPort.value)) {
            return disableSubmitWithError("Battery Alert Port value, min=1 max=65535");
        }
        
        // BLE passkey validation - only validate if BLE is enabled
        const isBleEnabled = elements.bleStatus.value === "enable";
        if (isBleEnabled) {
            const blePass = elements.blePassValue.value;
            if (blePass.length !== 6 || blePass.charAt(0) === "0") {
                return disableSubmitWithError("BLE Passkey: 6 digits required, first digit cannot be 0");
            }
        }
        
        // Sleep voltage validation
        const sleepVolt = parseFloat(elements.sleepVolt.value);
        if (sleepVolt < 12 || sleepVolt > 15) {
            return disableSubmitWithError("Sleep Voltage Value, min=12.0 max=15.0");
        }
        
        // Sleep disable agreement validation
        if (elements.sleepStatus.value === "disable" && elements.sleepDisableAgree.value === "no") {
            return disableSubmitWithError("You must agree to disable sleep mode");
        }
        
        // SmartConnect validation
        if (wifiMode === "SmartConnect") {
            return validateSmartConnect();
        }
        
        return true;
    }

    function validateSmartConnect() {
        const homeSSID = document.getElementById("home_ssid").value.trim();
        const homePassword = document.getElementById("home_password").value.trim();
        const driveConnectionType = document.getElementById("drive_connection_type").value;
        const driveSSID = document.getElementById("drive_ssid").value.trim();
        const drivePassword = document.getElementById("drive_password").value.trim();
        
        if (!homeSSID || !homePassword) {
            return disableSubmitWithError("SmartConnect: Home SSID and Password are required");
        }
        
        if (driveConnectionType === "wifi" && (!driveSSID || !drivePassword)) {
            return disableSubmitWithError("SmartConnect: Drive SSID and Password are required when WiFi is selected");
        }
        
        return true;
    }

    function configureProtocolSettings(elements) {
        const isSavvyCan = elements.protocol.value === "savvycan";
        const isElm327 = elements.protocol.value === "elm327";
        
        if (isSavvyCan) {
            elements.tcpPortValue.value = "23";
            elements.tcpPortValue.disabled = true;
            elements.portType.selectedIndex = 0;
            elements.portType.disabled = true;
        } else {
            elements.tcpPortValue.disabled = false;
            elements.portType.selectedIndex = 0;
            elements.portType.disabled = false;
        }
        
        elements.mqttElm327Log.disabled = !isElm327;
        if (!isElm327) {
            elements.mqttElm327Log.value = "disable";
        }
    }

    function configureSleepSettings(elements) {
        const sleepEnabled = elements.sleepStatus.value === "enable";
        const bleEnabled = elements.bleStatus.value === "enable";
        
        if (sleepEnabled) {
            if (!bleEnabled) {
                elements.battAlert.disabled = true;
            }
        } else {
            elements.battAlert.disabled = true;
            elements.battAlert.selectedIndex = 0;
        }
    }

    function configureMqttAndBatteryAlerts(elements) {
        // Battery alert div is always hidden in current logic
        elements.battAlertDiv.style.display = "none";
        
        // MQTT div visibility
        const mqttEnabled = elements.mqttEn.value === "enable";
        elements.mqttEnDiv.style.display = mqttEnabled ? "block" : "none";
    }

    function configurePeriodicWakeup(elements) {
        const sleepDisabled = elements.sleepStatus.value === "disable";
        
        if (sleepDisabled) {
            elements.periodicWakeup.disabled = true;
            elements.periodicWakeup.value = "disable";
            elements.wakeupEveryRow.style.display = "none";
        } else {
            elements.periodicWakeup.disabled = false;
            const wakeupEnabled = elements.periodicWakeup.value === "enable";
            elements.wakeupEveryRow.style.display = wakeupEnabled ? "table-row" : "none";
        }
    }
	document.getElementById("defaultOpen").click();

	function checkStatus() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			var obj = JSON.parse(this.responseText);
			if(obj.wifi_mode == "APStation") {
				document.getElementById("wifi_mode_current").innerHTML = "AP+Station";
			} else if(obj.wifi_mode == "AP") {
				document.getElementById("wifi_mode_current").innerHTML = "AP";
			} else if(obj.wifi_mode == "SmartConnect") {
				document.getElementById("wifi_mode_current").innerHTML = "SmartConnect";
			}

			document.getElementById("sta_status").innerHTML = obj.sta_status;
			document.getElementById("ap_channel_status").innerHTML = obj.ap_ch;
			document.getElementById("sta_ip").innerHTML = obj.sta_ip;
            document.getElementById("mdns").innerHTML = obj.mdns;
			document.getElementById("can_bitrate_status").innerHTML = obj.can_datarate;
			if(obj.can_mode == "normal") {
				document.getElementById("can_mode_status").innerHTML = "Normal";
			} else if(obj.can_mode == "silent") {
				document.getElementById("can_mode_status").innerHTML = "Silent";
			}
			if(obj.port_type == "tcp") {
				document.getElementById("port_type_status").innerHTML = "TCP";
			} else if(obj.port_type == "udp") {
				document.getElementById("port_type_status").innerHTML = "UDP";
			}
			document.getElementById("port_status").innerHTML = obj.port;
			document.getElementById("fw_version").innerHTML = obj.fw_version;
			document.getElementById("hw_version").innerHTML = obj.hw_version;
			document.getElementById("git_version").innerHTML = obj.git_version;
			document.getElementById("protocol").value = obj.protocol;
			document.getElementById("batt_voltage").innerHTML = obj.batt_voltage;
			if(document.getElementById("batt_alert").value == "enable") {
				document.getElementById("batt_alert_div").style.display = "none";
			} else if(document.getElementById("batt_alert").value == "disable") {
				document.getElementById("batt_alert_div").style.display = "none";
			}
			if(document.getElementById("mqtt_en").value == "enable") {
				document.getElementById("mqtt_en_div").style.display = "block";
			} else if(document.getElementById("mqtt_en").value == "disable") {
				document.getElementById("mqtt_en_div").style.display = "none";
			}
		};
		xhttp.open("GET", "/check_status");
		xhttp.send();
	}

	function loadCANFLT() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            if (this.responseText === "NONE") {
                return;
            }
            var obj = JSON.parse(this.responseText);
			if(this.responseText != "NONE") {
				if(Array.isArray(obj.can_flt)) {
					obj.can_flt.forEach((item) => {
						restoreCANFLTRow(item["CANID"], item["Name"], item["PID"], item["PIDIndex"], item["StartBit"], item["BitLength"], item["Expression"], item["Cycle"]);
					});
				}
			}
		};
		xhttp.open("GET", "/load_canflt");
		xhttp.send();
	}

    function loadautoPIDCarData() {
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
            console.log("Car models:", this.responseText);
            if(this.responseText != "NONE") {
                var obj = JSON.parse(this.responseText);
                const carModels = [];
                if (obj && Array.isArray(obj.cars)) {
                    obj.cars.forEach(car => {
                        if (car.car_model) {
                            carModels.push(car.car_model);
                        }
                        
                        if (car.pids) {
                            document.getElementById("specific_init").value = car.init;
                            car.pids.forEach(pid => {

                                if (pid.parameters) {
                                    pid.parameters.forEach(param => {
                                        addCarParameter({
                                            name: param.name,
                                            expression: param.expression,
                                            unit: param.unit,
                                            class: param.class, 
                                            period: param.period,
                                            type: param.type,
                                            min: param.min,
                                            max: param.max,
                                            send_to: param.send_to,
                                            pid: pid.pid,
                                            pid_init: pid.pid_init
                                        });
                                    });
                                }
                            });
                        }
                    });
                }
                var modifiedObj = { "supported": carModels };
                loadCarModels(modifiedObj);
            } else {
                toggleCarModel();
                toggleDestinationAndCycle();
                toggleSendToFields();
                toggleStandardPIDOptions();
            }
        };
        xhttp.open("GET", "/load_auto_pid_car_data");
        xhttp.send();
    }


    function loadautoPID() {
        console.log("Loading auto PID data..."); 
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
            console.log("Server response:", this.responseText);
            if(this.responseText !== "NONE") {
                const data = JSON.parse(this.responseText);
                loadAutoTable(data);
                document.getElementById("custom_pid_store").disabled = true;
            } else {
                console.log("No PID data found on server");
            }
        };
        xhttp.onerror = function(error) {
            console.error("Error loading auto PID:", error);
        };
        xhttp.open("GET", "/load_auto_pid");
        xhttp.send();
    }

	function postCANFLT() {
		var obj = {};
		obj["can_flt"] = canData;
		var canfltJSON = JSON.stringify(obj);
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            showNotification(this.responseText, "green");
			submit_enable();
		};
		xhttp.open("POST", "/store_canflt");
        xhttp.setRequestHeader("Content-Type", "application/json");
		xhttp.send(canfltJSON);
	}

	async function postConfig() {
		var obj = {};
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const storeResult = await storeAutoTableData();
        if (!storeResult) {
            return;
        }
		obj["wifi_mode"] = document.getElementById("wifi_mode").value;
		obj["ap_ch"] = document.getElementById("ap_ch_value").value;
		obj["sta_ssid"] = document.getElementById("ssid_value").value;
		obj["sta_pass"] = document.getElementById("pass_value").value;
		obj["sta_security"] = document.getElementById("sta_security").value;
		obj["home_ssid"] = document.getElementById("home_ssid").value;
		obj["home_password"] = document.getElementById("home_password").value;
		obj["home_security"] = document.getElementById("home_security").value;
		obj["drive_ssid"] = document.getElementById("drive_ssid").value;
		obj["drive_password"] = document.getElementById("drive_password").value;
		obj["drive_security"] = document.getElementById("drive_security").value;
		obj["home_protocol"] = document.getElementById("home_protocol").value;
		obj["drive_protocol"] = document.getElementById("drive_protocol").value;
		obj["drive_connection_type"] = document.getElementById("drive_connection_type").value;
		obj["drive_mode_timeout"] = document.getElementById("drive_mode_timeout").value;
		obj["can_datarate"] = document.getElementById("can_datarate").value;
		obj["can_mode"] = document.getElementById("can_mode").value;
		obj["port_type"] = document.getElementById("port_type").value;
		obj["port"] = document.getElementById("tcp_port_value").value;
		obj["ap_pass"] = document.getElementById("ap_pass_value").value;
		obj["protocol"] = document.getElementById("protocol").value;
		obj["ble_pass"] = document.getElementById("ble_pass_value").value;
		obj["ble_status"] = document.getElementById("ble_status").value;
		obj["sleep_status"] = document.getElementById("sleep_status").value;
		obj["sleep_disable_agree"] = document.getElementById("sleep_disable_agree").value;
		obj["periodic_wakeup"] = document.getElementById("periodic_wakeup").value;
		obj["sleep_volt"] = document.getElementById("sleep_volt").value;
		obj["sleep_time"] = document.getElementById("sleep_time").value;
		obj["wakeup_interval"] = document.getElementById("wakeup_interval").value;
		obj["batt_alert"] = document.getElementById("batt_alert").value;
		obj["batt_alert_ssid"] = document.getElementById("batt_alert_ssid").value;
		obj["batt_alert_pass"] = document.getElementById("batt_alert_pass").value;
		obj["batt_alert_volt"] = document.getElementById("batt_alert_volt").value;
		obj["batt_alert_protocol"] = document.getElementById("batt_alert_protocol").value;
		let mqtt_txt = "mqtt://";
		let mqtt_url_val = mqtt_txt.concat(document.getElementById("batt_alert_url").value);
		obj["batt_alert_url"] = mqtt_url_val;
		obj["batt_alert_port"] = document.getElementById("batt_alert_port").value;
		obj["batt_alert_topic"] = document.getElementById("batt_alert_topic").value;
		obj["batt_alert_time"] = document.getElementById("batt_alert_time").value;
		obj["batt_mqtt_user"] = document.getElementById("batt_mqtt_user").value;
		obj["batt_mqtt_pass"] = document.getElementById("batt_mqtt_pass").value;
		obj["mqtt_en"] = document.getElementById("mqtt_en").value;
		let mqtt_txt2 = "mqtt://";
		let mqtt_url_val2 = mqtt_txt.concat(document.getElementById("mqtt_url").value);
		obj["mqtt_url"] = mqtt_url_val2;
		obj["mqtt_port"] = document.getElementById("mqtt_port").value;
		obj["mqtt_user"] = document.getElementById("mqtt_user").value;
		obj["mqtt_pass"] = document.getElementById("mqtt_pass").value;
		obj["mqtt_tx_topic"] = document.getElementById("mqtt_tx_topic").value;
		obj["ap_auto_disable"] = document.getElementById("ap_auto_disable").value;
		if(document.getElementById("mqtt_tx_en_checkbox").checked){
			obj["mqtt_tx_en"] = "enable";
		}else{
			obj["mqtt_tx_en"] = "disable";
		}
		obj["mqtt_rx_topic"] = document.getElementById("mqtt_rx_topic").value;
		if(document.getElementById("mqtt_rx_en_checkbox").checked){
            obj["mqtt_rx_en"] = "enable";
        }else{
            obj["mqtt_rx_en"] = "disable";
        }
		obj["mqtt_status_topic"] = document.getElementById("mqtt_status_topic").value;
		obj["mqtt_elm327_log"] = document.getElementById("mqtt_elm327_log").value;
        obj["logger_status"] = document.getElementById("logger_status").value;
        obj["log_filesystem"] = document.getElementById("log_filesystem").value;
        obj["log_storage"] = document.getElementById("log_storage").value;
        obj["log_period"] = document.getElementById("log_period").value;
        obj["imu_threshold"] = document.getElementById("imu_threshold").value;

        // Collect fallback networks (max 5)
        try {
            const rows = document.querySelectorAll('#fallback_rows .fallback-row');
            const fallbacks = [];
            rows.forEach(r => {
                const ssid = r.querySelector('.fb-ssid').value.trim();
                const pass = r.querySelector('.fb-pass').value;
                const sec = r.querySelector('.fb-sec').value;
                if (ssid) {
                    fallbacks.push({ ssid, pass, security: sec });
                }
            });
            obj["sta_fallbacks"] = fallbacks.slice(0, 5);
        } catch (e) {
            console.warn('fallback networks parse error', e);
        }
		var configJSON = JSON.stringify(obj);
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
            showNotification(this.responseText, "green");
            document.getElementById("submit_button").disabled = true;
		};
        xhttp.onerror = function() {
            showNotification("Failed to save configuration", "red");
        };

		xhttp.open("POST", "/store_config");
        xhttp.setRequestHeader("Content-Type", "application/json");
		xhttp.send(configJSON);
	}

	function otaClick() {
		if(document.getElementById("ota_file").files.length == 0) {
            showNotification("No files selected!", "red");
			alert("No files selected!");
		} else {
			document.getElementById("ota_submit_button").disabled = true;
            showNotification("Updating please wait...", "green");
			setTimeout(function() {
				document.getElementById("ota_form").submit();
			}, 5000);
		}
	}

	function reboot() {
		const xhttp = new XMLHttpRequest();
		document.getElementById("reboot_button").disabled = true;
        showNotification("Rebooting please reconnect...", "yellow");
		xhttp.open("POST", "/system_reboot");
		xhttp.send("reboot");
	}

    function send_system_command(command) {
        const xhttp = new XMLHttpRequest();
        const data = {
            "command": command
        };
        xhttp.open("POST", "/system_commands");
        xhttp.send(JSON.stringify(data));
    }

    async function downloadCfg() {
        const endpoints = [
            '/load_config',
            '/load_auto_pid_car_data',
            '/load_auto_pid',
            '/load_canflt'
        ];
        
        const delay = 500; 
        let combinedData = {};
        let hasErrors = false;
        
        try {
            for (let i = 0; i < endpoints.length; i++) {
                const endpoint = endpoints[i];
                
                try {
                    const response = await fetch(endpoint);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const key = endpoint.replace('/load_', '');
                    combinedData[key] = data;
                } catch (fetchError) {
                    hasErrors = true;
                }
                
                if (i < endpoints.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            if (Object.keys(combinedData).length === 0) {
                throw new Error('No data was successfully fetched from any endpoint');
            }
            
            const dataStr = JSON.stringify(combinedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `config_${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            return true;
            
        } catch (error) {
            alert('Failed to download configuration');
            return false;
        }
    }

    async function uploadCfg() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return;

        const endpointMap = {
            'config': '/store_config',
            'auto_pid': '/store_auto_data',
            'auto_pid_car_data': '/store_car_data',
            'canflt': '/store_canflt'
        };

        const delay = 200;

        try {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    let hasErrors = false;

                    for (const [key, endpoint] of Object.entries(endpointMap)) {
                        if (jsonData[key]) {
                            try {
                                const response = await fetch(endpoint, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(jsonData[key])
                                });

                                if (!response.ok) {
                                    hasErrors = true;
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                await new Promise(resolve => setTimeout(resolve, delay));

                            } catch (fetchError) {
                                hasErrors = true;
                            }
                        }
                    }

                    if (hasErrors) {
                        alert('Some configurations failed to upload');
                    } else {
                        alert('Configuration uploaded successfully, Rebooting...');
                    }
                    
                    fileInput.value = '';

                } catch (parseError) {
                    alert('Failed to parse configuration file');
                }
            };

            reader.onerror = function() {
                alert('Error reading file');
            };

            reader.readAsText(file);

        } catch (error) {
            alert('Upload failed');
        }
    }

	function Load() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			var obj = JSON.parse(this.responseText);
			if(obj.wifi_mode == "APStation") {
				document.getElementById("wifi_mode").selectedIndex = "1";
				document.getElementById("ssid_value").disabled = false;
				document.getElementById("pass_value").disabled = false;
                document.getElementById("sta_security").disabled = false;
                document.getElementById("ap_auto_disable").disabled = false;
			} else if(obj.wifi_mode == "AP") {
				document.getElementById("wifi_mode").selectedIndex = "0";
				document.getElementById("ssid_value").disabled = true;
				document.getElementById("pass_value").disabled = true;
                document.getElementById("ap_auto_disable").disabled = true;
			} else if(obj.wifi_mode == "SmartConnect") {
				document.getElementById("wifi_mode").selectedIndex = "2";
			}

            // Load SmartConnect configuration
            document.getElementById("home_ssid").value = obj.home_ssid || "";
            document.getElementById("home_password").value = obj.home_password || "";
            document.getElementById("home_security").value = obj.home_security || "wpa3";
            document.getElementById("home_protocol").value = obj.home_protocol || "elm327";
            document.getElementById("drive_ssid").value = obj.drive_ssid || "";
            document.getElementById("drive_password").value = obj.drive_password || "";
            document.getElementById("drive_security").value = obj.drive_security || "wpa3";
            document.getElementById("drive_protocol").value = obj.drive_protocol || "elm327";
            document.getElementById("drive_connection_type").value = obj.drive_connection_type || "wifi";
            // Load drive mode timeout value and update display
            document.getElementById("drive_mode_timeout").value = obj.drive_mode_timeout || "60";
            document.getElementById("drive_mode_timeout_value").textContent = obj.drive_mode_timeout || "60";
            
            if(obj.ap_auto_disable == "enable") {
				document.getElementById("ap_auto_disable").selectedIndex = "0";
			} else {
				document.getElementById("ap_auto_disable").selectedIndex = "1";
			}

			var ch = parseInt(obj.ap_ch);
			ch = ch - 1;
			document.getElementById("ap_ch_value").selectedIndex = ch.toString();
			document.getElementById("ssid_value").value = obj.sta_ssid;
			document.getElementById("pass_value").value = obj.sta_pass;
            document.getElementById("sta_security").value = obj.sta_security || "wpa3";			
            if(obj.can_datarate == "5K") {
				document.getElementById("can_datarate").selectedIndex = "0";
			} else if(obj.can_datarate == "10K") {
				document.getElementById("can_datarate").selectedIndex = "1";
			} else if(obj.can_datarate == "20K") {
				document.getElementById("can_datarate").selectedIndex = "2";
			} else if(obj.can_datarate == "25K") {
				document.getElementById("can_datarate").selectedIndex = "3";
			} else if(obj.can_datarate == "50K") {
				document.getElementById("can_datarate").selectedIndex = "4";
			} else if(obj.can_datarate == "100K") {
				document.getElementById("can_datarate").selectedIndex = "5";
			} else if(obj.can_datarate == "125K") {
				document.getElementById("can_datarate").selectedIndex = "6";
			} else if(obj.can_datarate == "250K") {
				document.getElementById("can_datarate").selectedIndex = "7";
			} else if(obj.can_datarate == "500K") {
				document.getElementById("can_datarate").selectedIndex = "8";
			} else if(obj.can_datarate == "800K") {
				document.getElementById("can_datarate").selectedIndex = "9";
			} else if(obj.can_datarate == "1000K") {
				document.getElementById("can_datarate").selectedIndex = "10";
			} else if(obj.can_datarate == "auto") {
				document.getElementById("can_datarate").selectedIndex = "11";
			}
			if(obj.can_mode == "normal") {
				document.getElementById("can_mode").selectedIndex = "0";
			} else if(obj.can_mode == "silent") {
				document.getElementById("can_mode").selectedIndex = "1";
			}
			if(obj.port_type == "tcp") {
				document.getElementById("port_type").selectedIndex = "0";
			} else if(obj.port_type == "udp") {
				document.getElementById("port_type").selectedIndex = "1";
			}
			if(obj.ble_status == "enable") {
				document.getElementById("ble_status").selectedIndex = 0;
			} else if(obj.ble_status == "disable") {
				document.getElementById("ble_status").selectedIndex = 1;
			}
			if(obj.sleep_status == "enable") {
				document.getElementById("sleep_status").selectedIndex = "0";
			} else if(obj.sleep_status == "disable") {
				document.getElementById("sleep_status").selectedIndex = "1";
			}

            if(obj.sleep_disable_agree == "yes") {
                document.getElementById("sleep_disable_agree").selectedIndex = "1";
            } else {
                document.getElementById("sleep_disable_agree").selectedIndex = "0";
            }
            toggleSleepWarning();
            if(obj.periodic_wakeup == "enable") {
				document.getElementById("periodic_wakeup").selectedIndex = "0";
			} else if(obj.periodic_wakeup == "disable") {
				document.getElementById("periodic_wakeup").selectedIndex = "1";
			}

			if ("mqtt_tx_en" in obj) {
				if (obj.mqtt_tx_en === "enable") {
					document.getElementById("mqtt_tx_en_checkbox").checked = true;
				} else {
					document.getElementById("mqtt_tx_en_checkbox").checked = false;
				}
			} else {
				document.getElementById("mqtt_tx_en_checkbox").checked = false; 
                document.getElementById("mqtt_tx_topic").disabled = true;
			}
			
            if ("mqtt_rx_en" in obj) {
                if (obj.mqtt_rx_en === "enable") {
                    document.getElementById("mqtt_rx_en_checkbox").checked = true;
                } else {
                    document.getElementById("mqtt_rx_en_checkbox").checked = false;
                }
            } else {
                document.getElementById("mqtt_rx_en_checkbox").checked = false;
                document.getElementById("mqtt_rx_topic").disabled = true;
            }
            
            if (obj.logger_status === "enable") {
                document.getElementById("logger_status").selectedIndex = "0";
            } else if (obj.logger_status === "disable") {
                document.getElementById("logger_status").selectedIndex = "1";
            }

            if (obj.log_filesystem === "fatfs") {
                document.getElementById("log_filesystem").selectedIndex = "0";
            }

            if (obj.log_storage === "sdcard") {
                document.getElementById("log_storage").selectedIndex = "0";
            } else if (obj.log_storage === "internal") {
                document.getElementById("log_storage").selectedIndex = "1";
            }

            document.getElementById('log_period_value').textContent = obj.log_period;
            
            // Load IMU threshold value and update display
            document.getElementById("imu_threshold").value = obj.imu_threshold || "8";
            document.getElementById("imu_threshold_value").textContent = ((obj.imu_threshold || 8) * 3.9).toFixed(1) + ' mg';
			
			txCheckBoxChanged();
            rxCheckBoxChanged();
			document.getElementById("protocol").value = obj.protocol;
			document.getElementById("tcp_port_value").value = obj.port;
			document.getElementById("ap_pass_value").value = obj.ap_pass;
			document.getElementById("ble_pass_value").value = obj.ble_pass;
			document.getElementById("sleep_volt").value = obj.sleep_volt;
            document.getElementById("sleep_volt_value").textContent = obj.sleep_volt;
            document.getElementById("sleep_time").value = obj.sleep_time;
            document.getElementById('sleep_time_value').textContent = obj.sleep_time;
            document.getElementById("wakeup_interval").value = obj.wakeup_interval;
            document.getElementById('wakeup_interval_value').textContent = obj.wakeup_interval;
			document.getElementById("batt_alert").value = "disable";
			document.getElementById("batt_alert_ssid").value = obj.batt_alert_ssid;
			document.getElementById("batt_alert_pass").value = obj.batt_alert_pass;
			document.getElementById("batt_alert_volt").value = obj.batt_alert_volt;
			document.getElementById("batt_alert_protocol").value = obj.batt_alert_protocol;
			document.getElementById("batt_alert_url").value = obj.batt_alert_url.slice(7);
			document.getElementById("batt_alert_port").value = obj.batt_alert_port;
			document.getElementById("batt_alert_topic").value = obj.batt_alert_topic;
			document.getElementById("batt_mqtt_user").value = obj.batt_mqtt_user;
			document.getElementById("batt_mqtt_pass").value = obj.batt_mqtt_pass;
			document.getElementById("mqtt_en").value = obj.mqtt_en;
			document.getElementById("mqtt_url").value = obj.mqtt_url.slice(7);
			document.getElementById("mqtt_port").value = obj.mqtt_port;
			document.getElementById("mqtt_user").value = obj.mqtt_user;
			document.getElementById("mqtt_pass").value = obj.mqtt_pass;
			document.getElementById("mqtt_tx_topic").value = obj.mqtt_tx_topic;
			document.getElementById("mqtt_rx_topic").value = obj.mqtt_rx_topic;
			document.getElementById("mqtt_status_topic").value = obj.mqtt_status_topic;
			document.getElementById("mqtt_elm327_log").value = obj.mqtt_elm327_log;
			if(obj.batt_alert_time == "1") {
				document.getElementById("batt_alert_time").selectedIndex = "0";
			} else if(obj.batt_alert_time == "6") {
				document.getElementById("batt_alert_time").selectedIndex = "1";
			} else if(obj.batt_alert_time == "12") {
				document.getElementById("batt_alert_time").selectedIndex = "2";
			} else if(obj.batt_alert_time == "24") {
				document.getElementById("batt_alert_time").selectedIndex = "3";
			}
			if(document.getElementById("protocol").value == "savvycan") {
				document.getElementById("tcp_port_value").value = "23";
				document.getElementById("tcp_port_value").disabled = true;
				document.getElementById("port_type").selectedIndex = "0";
				document.getElementById("port_type").disabled = true;
			}
			if(document.getElementById("batt_alert").value == "enable") {
				document.getElementById("batt_alert_div").style.display = "none";
			} else if(document.getElementById("batt_alert").value == "disable") {
				document.getElementById("batt_alert_div").style.display = "none";
			}
			if(document.getElementById("mqtt_en").value == "enable") {
				document.getElementById("mqtt_en_div").style.display = "block";
			} else if(document.getElementById("mqtt_en").value == "disable") {
				document.getElementById("mqtt_en_div").style.display = "none";
			}
			loadCANFLT();
			loadautoPIDCarData();
            loadautoPID();

            // Load fallback networks if present
            try {
                const fb = Array.isArray(obj.sta_fallbacks) ? obj.sta_fallbacks : [];
                renderFallbackNetworks(fb);
            } catch(e) {
                renderFallbackNetworks([]);
            }
            document.getElementById("car_model").addEventListener('change', function() {
                document.querySelector('.specific-pid-entries').innerHTML = '';
                
                const selectedModel = this.value;
                if (latest_car_models && Array.isArray(latest_car_models.cars)) {
                    const selectedCar = latest_car_models.cars.find(car => car.car_model === selectedModel);
                    const specificInitElement = document.getElementById("specific_init");
                    specificInitElement.value = selectedCar.init;
                    if (selectedCar && selectedCar.pids) {
                        selectedCar.pids.forEach(pid => {
                            if (pid.parameters) {
                                pid.parameters.forEach(param => {
                                    addCarParameter({
                                        ...param,
                                        pid: pid.pid,
                                        pid_init: pid.pid_init
                                    });
                                });
                            }
                        });
                    }
                }
            });
			document.getElementById("store_canflt_button").disabled = true;
			document.querySelector(".store").disabled = true;
            document.getElementById("submit_button").disabled = true;
		};
		checkStatus();
		xhttp.open("GET", "/load_config");
		xhttp.send();
		
		// Initialize SmartConnect configuration visibility
		toggleSmartConnectConfig();
		
		// Initialize lucide icons
		if (typeof lucide !== 'undefined' && lucide.createIcons) {
			lucide.createIcons();
		}
	}

	function monitor_add_line(id, type, len, data, time) {
		var table = document.getElementById("table2");
		var nraw = -1;
		if(typeof monitor_add_line.msg_time == "undefined") {
			monitor_add_line.msg_time = [0];
		}
		for(var r = 1, n = table.rows.length; r < n; r++) {
			if(table.rows[r].cells[0].innerHTML == id) {
				nraw = r;
				break;
			}
		}
		if(nraw != -1) {
			table.rows[nraw].cells[0].innerHTML = id;
			table.rows[nraw].cells[1].innerHTML = type;
			table.rows[nraw].cells[2].innerHTML = len;
			table.rows[nraw].cells[3].innerHTML = data;
			table.rows[nraw].cells[4].innerHTML = Date.now() - monitor_add_line.msg_time[nraw];
			table.rows[nraw].cells[5].innerHTML = ++table.rows[nraw].cells[5].innerHTML;
			monitor_add_line.msg_time[nraw] = Date.now();
		} else {
			var row = table.insertRow(1);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			var cell3 = row.insertCell(2);
			var cell4 = row.insertCell(3);
			var cell5 = row.insertCell(4);
			var cell6 = row.insertCell(5);
			cell1.innerHTML = id;
			cell2.innerHTML = type;
			cell3.innerHTML = len;
			cell4.innerHTML = data;
			cell5.innerHTML = 0;
			cell6.innerHTML = 1;
            cell1.style.width = "10%"
			monitor_add_line.msg_time.push(Date.now());
		}
	}
	var ws = null;
	var cr = String.fromCharCode(13);

	function mon_control() {
		var dr = document.getElementById("mon_datarate").selectedIndex;
		var url = window.location.href;
		var url2 = "http://192.168.31.72/";
		console.log(dr);
		alert("Please reboot device after Monitor, otherwise the device may not function as expected");
		ws_url = "ws://" + url.substr(7, url.length) + "ws";
		console.log(ws_url);
		if(document.getElementById("mon_button").value == "Start") {
			ws = new WebSocket(ws_url);
			setTimeout(bindEvents, 1000);
			ws.addEventListener("open", (event) => {
				var cmd = "C" + cr + "S" + dr + cr + "O" + cr;
				console.log("onopen called");
				ws.send(cmd);
				window.mon_button_en(0);
			});
			ws.addEventListener("close", (event) => {
				window.mon_button_en(1);
				console.log("onclose called");
			});
		} else {
			ws_close();
		}
	}

	function bindEvents() {
		ws.onmessage = function(evt) {
			var received_msg = evt.data;
			if(received_msg[0] == "t") {
				var len = (received_msg[4] - "0") * 2;
				var data_str = "";
				var i;
				for(i = 0; i < len; i += 2) {
					data_str += received_msg.substr(i + 5, 2) + " ";
				}
				monitor_add_line(received_msg.substr(1, 3) + "h", "Std", received_msg[4], data_str, 0);
			} else if(received_msg[0] == "T") {
				var len = (received_msg[9] - "0") * 2;
				var data_str = "";
				var i;
				for(i = 0; i < len; i += 2) {
					data_str += received_msg.substr(i + 10, 2) + " ";
				}
				monitor_add_line(received_msg.substr(1, 8) + "h", "Ext", received_msg[9], data_str, 0);
			} else if(received_msg[0] == "r") {
				var len = (received_msg[4] - "0") * 2;
				monitor_add_line(received_msg.substr(1, 3) + "h", "RTR-Std", received_msg[4], 0, 0);
			} else if(received_msg[0] == "R") {
				var len = (received_msg[9] - "0") * 2;
				monitor_add_line(received_msg.substr(1, 8) + "h", "RTR-Ext", received_msg[9], 0, 0);
			}
		};
	}

	function ws_close() {
		ws.send("C" + cr);
		ws.close();
	}

	function mon_button_en(b) {
		if(b == 1) {
			document.getElementById("mon_button").value = "Start";
			document.getElementById("mon_datarate").disabled = false;
			document.getElementById("mon_filter").disabled = false;
			document.getElementById("mon_mask").disabled = false;
		} else {
			document.getElementById("mon_button").value = "Stop";
			document.getElementById("mon_datarate").disabled = true;
			document.getElementById("mon_filter").disabled = true;
			document.getElementById("mon_mask").disabled = true;
		}
	}

	function isNameUnique(name) {
		return canData.every((item) => item["Name"] !== name);
	}

	function addCANFLTRow() {
		var canId = parseInt(document.getElementById("canId").value);
		var startBit = parseInt(document.getElementById("startBit").value);
		var bitLength = parseInt(document.getElementById("bitLength").value);
		Length = parseInt(document.getElementById("bitLength").value);
		var cycle = parseInt(document.getElementById("cycle").value);
		var name = document.getElementById("name").value;
		var expression = document.getElementById("expression").value;
		var pid = parseInt(document.getElementById("pid").value);
		var pidi = parseInt(document.getElementById("pindex").value);
		if(isNaN(canId) || canId == "" || canId < 0 || canId > 536870912) {
			alert("CAN ID must be a valid number between 0 and 536870912");
			return;
		}
		if(isNaN(startBit) || isNaN(bitLength) || startBit > 64 - bitLength || bitLength <= 0 || bitLength > 64 || startBit < 0 || startBit > 63) {
			alert("startBit or bitLength error");
			return;
		}
		if(isNaN(cycle) || cycle < 100 || cycle > 10000) {
			alert("cycle must be between 100 and 10000");
			return;
		}
		if(name.length < 1 || name.length > 16) {
			alert("Name must be between 1 and 16 characters in length.");
			return;
		}
		if(expression.length < 1 || expression.length > 64) {
			alert("Expression must be between 1 and 64 characters in length.");
			return;
		}
		if(isNaN(pid) || pid < -1 || pid > 255) {
			alert("PID must be a number between -1 and 255");
			return;
		}
		if(isNaN(pidi) || pidi < 0 || pidi > 7) {
			alert("PID must be a number between 0 and 7");
			return;
		}
		if(isNameUnique(name)) {
			var table = document.getElementById("can_flt_table");
			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			var cell3 = row.insertCell(2);
			var cell4 = row.insertCell(3);
			var cell5 = row.insertCell(4);
			var cell6 = row.insertCell(5);
			var cell7 = row.insertCell(6);
			var cell8 = row.insertCell(7);
			var cell9 = row.insertCell(8);
			if(table.rows.length - 1 >= 100) {
				alert("Maximum row limit (100) reached.");
				return;
			}
			cell1.innerHTML = canId;
			cell2.innerHTML = name;
			cell3.innerHTML = pid;
			cell4.innerHTML = pidi;
			cell5.innerHTML = startBit;
			cell6.innerHTML = bitLength;
			cell7.innerHTML = expression;
			cell8.innerHTML = cycle;
			cell9.innerHTML = '<button style="width: 100%;" onclick="deleteCANFLTRow(this) ">Delete</button>';
			canData.push({
				CANID: canId,
				Name: name,
				PID: pid,
				PIDIndex: pidi,
				StartBit: startBit,
				BitLength: bitLength,
				Expression: expression,
				Cycle: cycle
			});
			document.getElementById("canId").value = "";
			document.getElementById("name").value = "";
			document.getElementById("pid").value = "";
			document.getElementById("pindex").value = "";
			document.getElementById("startBit").value = "";
			document.getElementById("bitLength").value = "";
			document.getElementById("expression").value = "";
			document.getElementById("cycle").value = "";
		} else {
			alert("Name must be unique.");
		}
		document.getElementById("store_canflt_button").disabled = false;
	}

	function deleteCANFLTRow(button) {
		var row = button.parentNode.parentNode;
		var canIdToDelete = row.cells[0].textContent;
		var indexToDelete = canData.findIndex((item) => item["CANID"] === parseInt(canIdToDelete));
		if(indexToDelete !== -1) {
			canData.splice(indexToDelete, 1);
		}
		row.parentNode.removeChild(row);
		document.getElementById("store_canflt_button").disabled = false;
	}

	function alert_elm327() {
		alert("If elm327 log is enabled then only CAN frames proccessed by elm327 will be sent to MQTT broker.");
	}

	function storeCANFLT() {
		postCANFLT();
		document.getElementById("store_canflt_button").disabled = true;
	}

    function toggleSleepWarning() {
        const sleepStatus = document.getElementById("sleep_status").value;
        const sleepWarningDiv = document.getElementById("sleep_warning_div");
        const agreementSelect = document.getElementById("sleep_disable_agree");
        
        if (sleepStatus === "disable") {
            sleepWarningDiv.style.display = "block";
            agreementSelect.value = "no";
        } else {
            sleepWarningDiv.style.display = "none";
        }
    }

    async function scanWifiNetworks() {
        const scanButton = document.getElementById('wifi_scan_button');
        const networksList = document.getElementById('wifi_networks_list');
        const networksRow = document.getElementById('wifi_networks_row');
        
        try {
            scanButton.disabled = true;
            scanButton.textContent = "Scanning...";
            
            const response = await fetch('/wifi_scan');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.text();
            
            // Clear existing options
            networksList.innerHTML = '<option value="">Select a network...</option>';
            
            if (data && data !== "NONE") {
                try {
                    const scanResult = JSON.parse(data);
                    if (scanResult.networks && Array.isArray(scanResult.networks)) {
                        // Filter out networks with empty SSID and sort by signal strength
                        const validNetworks = scanResult.networks
                            .filter(network => network.ssid && network.ssid.trim() !== '')
                            .sort((a, b) => b.rssi - a.rssi); // Sort by signal strength (strongest first)
                        
                        // Remove duplicates (same SSID, keep the strongest signal)
                        const uniqueNetworks = [];
                        const seenSSIDs = new Set();
                        
                        validNetworks.forEach(network => {
                            if (!seenSSIDs.has(network.ssid)) {
                                seenSSIDs.add(network.ssid);
                                uniqueNetworks.push(network);
                            }
                        });
                        
                        if (uniqueNetworks.length > 0) {
                            uniqueNetworks.forEach(network => {
                                const option = document.createElement('option');
                                option.value = network.ssid;
                                
                                // Create a nice display name with signal strength and security
                                const signalBars = getSignalQuality(network.rssi);
                                const security = getSecurityType(network.auth_mode);
                                option.textContent = `${network.ssid} (${signalBars}, ${network.rssi} dBm, ${security})`;
                                
                                networksList.appendChild(option);
                            });
                            networksRow.style.display = 'table-row';
                            showNotification(`Found ${uniqueNetworks.length} WiFi networks`, "green");
                        } else {
                            showNotification("No valid networks found", "yellow");
                        }
                    } else {
                        throw new Error("Invalid scan data format");
                    }
                } catch (parseError) {
                    console.error('Parse error:', parseError);
                    showNotification("Failed to parse scan results", "red");
                }
            } else {
                showNotification("No networks found", "yellow");
            }
        } catch (error) {
            console.error('WiFi scan error:', error);
            showNotification("WiFi scan failed: " + error.message, "red");
        } finally {
            scanButton.disabled = false;
            scanButton.textContent = "Scan";
        }
    }

    function getSignalQuality(rssi) {
        // Convert RSSI to signal quality text
        if (rssi >= -50) return "Excellent"; // Excellent
        if (rssi >= -60) return "Good";      // Good  
        if (rssi >= -70) return "Fair";      // Fair
        return "Weak";                       // Weak
    }

    function getSecurityType(authMode) {
        // Simplify auth mode display
        switch(authMode) {
            case "OPEN": return "Open";
            case "WPA_PSK": return "WPA";
            case "WPA2_PSK": return "WPA2";
            case "WPA_WPA2_PSK": return "WPA/WPA2";
            case "WPA2_WPA3_PSK": return "WPA2/WPA3";
            case "WPA3_PSK": return "WPA3";
            default: return authMode;
        }
    }

    function selectWifiNetwork() {
        const networksList = document.getElementById('wifi_networks_list');
        const ssidInput = document.getElementById('ssid_value');
        
        if (networksList.value) {
            ssidInput.value = networksList.value;
            submit_enable(); // Trigger form validation
            enableAutoStoreButton(); // Enable store button if it exists
        }
    }
    </script>
    
    <!-- Lucide Icons -->
    <script src="/lucide_icons.js"></script>
</body>

</html>
